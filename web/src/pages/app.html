

<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <meta name="color-scheme" content="light" />
    <title>SENTRY MESSENGER — App</title>
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="/assets/styles.css" />
    <!-- Icons: Boxicons -->
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/assets/profile-extra.css" />
    <style>
      :root { color-scheme: light; --bg:#fff; --fg:#111827; --muted:#6b7280; --line:#e5e7eb; --brand:#111827; }
      * { box-sizing: border-box; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans TC', sans-serif; margin: 0; background:var(--bg); color:var(--fg); }
      .topbar { position: sticky; top:0; z-index:10; display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:none; background:#fff; backdrop-filter:saturate(180%) blur(6px); box-shadow:0 1px 0 rgba(15,23,42,0.04); }
      .topbar .title { display:flex; align-items:center; gap:10px; font-size:16px; font-weight:700; letter-spacing:0.4px; }
      .topbar .actions { display:flex; align-items:center; }
      .topbar .title img.brand { height:20px; width:auto; display:block; }
      .connection-indicator { display:inline-flex; align-items:center; gap:6px; font-size:12px; font-weight:500; color:#94a3b8; }
      .connection-indicator .dot { width:10px; height:10px; border-radius:999px; background:#ef4444; box-shadow:0 0 0 1px rgba(15,23,42,0.08); transition:background .2s ease, box-shadow .2s ease; }
      .connection-indicator.online .dot { background:#22c55e; box-shadow:0 0 0 1px rgba(34,197,94,0.4); }
      .connection-indicator.connecting .dot { background:#f97316; box-shadow:0 0 0 1px rgba(249,115,22,0.35); }
      .user-menu { position:relative; }
      .user-avatar-btn { width:36px; height:36px; border-radius:50%; border:1px solid rgba(15,23,42,0.08); background:#f8fafc; padding:0; display:inline-flex; align-items:center; justify-content:center; overflow:hidden; box-shadow:0 6px 18px rgba(15,23,42,0.12); cursor:pointer; transition:transform .16s ease, box-shadow .16s ease; }
      .user-avatar-btn:active { transform:scale(0.97); }
      .user-avatar-btn img { width:100%; height:100%; object-fit:cover; }
      .user-menu-dropdown { position:absolute; top:calc(100% + 10px); right:0; min-width:168px; border-radius:14px; border:1px solid rgba(15,23,42,0.08); background:#fff; box-shadow:0 18px 36px rgba(15,23,42,0.18); padding:8px 0; display:none; }
      .user-menu-dropdown.open { display:block; }
      .user-menu-item { width:100%; display:flex; align-items:center; gap:8px; padding:10px 16px; background:none; border:none; text-align:left; font-size:14px; color:#0f172a; cursor:pointer; letter-spacing:0.2px; }
      .user-menu-item:hover, .user-menu-item:focus { background:#f1f5f9; outline:none; }
      .user-menu-item.logout { color:#b91c1c; }
      .user-menu-divider { height:1px; background:rgba(148,163,184,0.35); margin:6px 0; }
      .icon-btn { display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border:1px solid var(--line); border-radius:12px; background:#fff; }
      .icon-btn i { font-size:18px; }
      .icon-btn.danger { background:linear-gradient(180deg,#ef4444,#b91c1c); color:#fff; border-color:#b91c1c; box-shadow:0 6px 16px rgba(185,28,28,0.25); }
      .content { padding: 12px 12px calc(80px + env(safe-area-inset-bottom, 0px)); display:flex; flex-direction:column; min-height:calc(100vh - 64px); }
      .content.fullscreen { padding:12px 12px 12px; }
      .content > .tab { flex:1 1 auto; min-height:0; }
      body.messages-fullscreen { overflow:hidden; }
      body.messages-fullscreen main.content.fullscreen { height:calc(100vh - 64px); overflow:hidden; display:flex; flex-direction:column; }
      body.messages-fullscreen .messages-pane { flex:1 1 auto; }
      body.messages-fullscreen .messages-thread { flex:1 1 auto; }
      body.messages-fullscreen .messages-scroll { height:100%; overflow-y:auto; }
      .messages-header { position:sticky; top:0; z-index:5; background:#fff; }
      .messages-peer-avatar { width:36px; height:36px; border-radius:50%; overflow:hidden; background:#e2e8f0; display:flex; align-items:center; justify-content:center; font-size:14px; color:#64748b; }
      .messages-peer-avatar img { width:100%; height:100%; object-fit:cover; display:block; }
      .navbar { position: fixed; bottom: 0; left:0; right:0; border-top:1px solid var(--line); background:#fff; display:flex; justify-content:space-around; padding:6px 0 calc(6px + env(safe-area-inset-bottom, 0px)); box-shadow: 0 -6px 20px rgba(0,0,0,0.06); backdrop-filter:saturate(180%) blur(8px); }
      .navbtn { position:relative; display:flex; flex-direction:column; align-items:center; gap:2px; border:none; background:none; padding:8px 10px; color:#6b7280; font-size:11px; min-width:72px; }
      .nav-badge { position:absolute; top:2px; right:12px; min-width:18px; padding:1px 4px; border-radius:999px; background:linear-gradient(135deg,#2563eb,#1d4ed8); color:#fff; font-size:10px; font-weight:600; line-height:1.2; display:none; box-shadow:0 4px 10px rgba(37,99,235,0.25); }
      .navbtn.has-badge .nav-badge { display:inline-flex; align-items:center; justify-content:center; }
      .navbtn.active, .navbtn:focus { color:#111827; }
      .tab { display:none; }
      /* Fallback: show Drive tab by default in case JS fails */
      #tab-drive { display:block; }
      .card { border: 1px solid var(--line); border-radius: 10px; padding: 12px; margin: 12px 0; }
      #tab-contacts { min-height: calc(100vh - 120px); display:flex; }
      #tab-contacts .card.contacts-card { padding: 0; margin:0; border:none; border-radius:0; overflow:hidden; flex:1; display:flex; background:transparent; box-shadow:none; min-height:100%; }
      .contacts-scroll { position: relative; padding: 0; flex:1 1 auto; display:flex; flex-direction:column; min-height:100%; }
      .contacts-refresh { position: relative; display:flex; align-items:center; justify-content:center; gap:8px; height:44px; margin:-40px 0 8px; color:#64748b; font-size:12px; letter-spacing:0.3px; opacity:0; pointer-events:none; }
      .contacts-refresh .icon { font-size:18px; display:inline-flex; align-items:center; justify-content:center; }
      .contacts-refresh.loading .icon { animation: modal-spin .9s linear infinite; }
      .contacts-refresh.ready { color:#0f172a; font-weight:500; }
      .contacts-refresh.ready .icon { color:#0f172a; }
      .contact-list { list-style:none; padding-left:0; margin:5px 0 0; display:flex; flex-direction:column; gap:12px; flex:1 1 auto; overflow-y:auto; }
      .contact-item { position:relative; display:flex; align-items:center; justify-content:flex-start; }
      .contact-item .item-content { display:flex; align-items:center; gap:12px; width:100%; padding:12px; border:1px solid var(--line); border-radius:14px; background:#fff; box-shadow:0 8px 16px rgba(15,23,42,0.06); transition:transform .18s ease; }
      .contact-item .avatar { width:44px; height:44px; border-radius:50%; background:#e2e8f0; overflow:hidden; display:flex; align-items:center; justify-content:center; font-size:18px; color:#64748b; }
      .contact-item .avatar img { width:100%; height:100%; object-fit:cover; }
      .contact-item .info { display:flex; flex-direction:column; gap:4px; flex:1; min-width:0; }
      .contact-item .info .name { font-size:15px; font-weight:600; color:#0f172a; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
      .contact-item .info .meta { font-size:11px; color:#94a3b8; letter-spacing:0.2px; }
      .contact-item .item-delete { position:absolute; top:0; right:0; bottom:0; width:72px; border:none; background:#ef4444; color:#fff; display:flex; align-items:center; justify-content:center; font-size:22px; cursor:pointer; pointer-events:none; opacity:0; transition:opacity .18s ease; }
      .contact-item .item-delete:active { transform:translateY(1px); }
      .contact-item.show-delete .item-content { transform:translateX(-72px); }
      .contact-item.show-delete .item-delete { pointer-events:auto; opacity:1; }
      .contact-empty { color:#94a3b8; padding:24px 6px; text-align:center; font-size:13px; letter-spacing:0.3px; }
      .row { display:flex; gap:10px; align-items:center; }
      .row input[type="file"]{ flex:1; max-width:100%; }
      .row button{ flex-shrink:0; }
      input[type="file"], input[type="text"], input[type="password"] { border:1px solid var(--line); border-radius:10px; padding:10px 12px; font-size:15px; background:#fff; }
      button { padding:10px 14px; border:1px solid var(--line); border-radius:12px; background:#fff; cursor:pointer; touch-action: manipulation; }
      button.loading { pointer-events:none; opacity:0.85; display:inline-flex; align-items:center; justify-content:center; gap:8px; }
      button.loading .btn-label { display:inline-flex; align-items:center; }
      button.loading .btn-spinner { width:16px; height:16px; border-radius:50%; border:2px solid rgba(15,23,42,0.25); border-top-color:#0f172a; animation:modal-spin .8s linear infinite; }
      button.primary.loading .btn-spinner { border-color:rgba(248,250,252,0.45); border-top-color:#fff; }
      button.primary { background:linear-gradient(180deg,#111827,#0f172a); color:#fff; border-color:#0f172a; box-shadow:0 6px 16px rgba(2,6,23,0.15); }
      button.primary:active { transform: translateY(1px); }
      .list-header { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; margin-bottom:12px; flex-wrap:wrap; }
      .crumb { display:flex; flex-wrap:wrap; align-items:center; gap:4px; color:#6b7280; letter-spacing:0.3px; }
      .crumb .crumb-link { background:none; border:none; padding:0; color:#2563eb; cursor:pointer; font-size:13px; font-weight:500; }
      .crumb .crumb-link:active { transform:translateY(1px); }
      .crumb .crumb-current { font-size:13px; color:#0f172a; font-weight:600; }
      .crumb .sep { color:#cbd5f5; margin:0 4px; }
      .list-actions { display:flex; gap:8px; flex-wrap:wrap; }
      .list-actions button { display:inline-flex; align-items:center; justify-content:center; width:44px; height:44px; padding:0; border:1px solid var(--line); border-radius:12px; background:#f1f5f9; cursor:pointer; transition:background .2s, color .2s, border-color .2s, transform .15s ease; }
      .list-actions button i { font-size:18px; color:#0f172a; }
      .list-actions button:hover { background:#e2e8f0; }
      .list-actions button:active { transform:translateY(1px); }
      .list { list-style:none; padding-left:0; margin:0; display:flex; flex-direction:column; gap:8px; }
      .file-item { position:relative; display:flex; align-items:center; gap:0; padding:0; border:1px solid var(--line); border-radius:16px; background:#fff; box-shadow:0 6px 20px rgba(15,23,42,0.05); transition:transform .15s ease, box-shadow .15s ease; cursor:pointer; outline:none; overflow:hidden; touch-action: pan-y; }
      .file-item.folder { background:#f8fafc; }
      .file-item:hover { transform:translateY(-1px); box-shadow:0 12px 28px rgba(15,23,42,0.08); }
      .file-item:focus-visible { box-shadow:0 0 0 2px rgba(37,99,235,0.35); transform:none; }
      .file-item .item-content { display:flex; align-items:center; gap:14px; padding:16px 18px; width:100%; transition:transform .18s ease; }
      .file-item .meta { display:flex; flex-direction:column; gap:6px; flex:1; min-width:0; }
      .file-item .meta .name { display:flex; align-items:center; gap:8px; font-weight:600; font-size:15px; color:#0f172a; min-width:0; }
      .file-item .meta .name .label { display:block; flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
      .file-item .meta .name i { font-size:20px; color:#2563eb; }
      .file-item.folder .meta .name i { color:#f59e0b; }
      .file-item .sub { color:#6b7280; font-size:12px; letter-spacing:0.3px; }
      .file-item .item-delete { position:absolute; top:0; right:0; bottom:0; width:72px; border:none; background:#ef4444; color:#fff; display:flex; align-items:center; justify-content:center; font-size:22px; cursor:pointer; pointer-events:none; transition:opacity .18s ease; opacity:0; }
      .file-item .item-delete i { pointer-events:none; }
      .file-item.show-delete .item-content { transform:translateX(-72px); }
      .file-item.show-delete .item-delete { pointer-events:auto; opacity:1; }
      .file-item .item-delete:active { transform:translateY(1px); }
      .empty { color:#6b7280; padding:24px 6px; text-align:center; font-size:13px; letter-spacing:0.3px; }
      pre#out { white-space: pre-wrap; background:#f9fafb; border:1px solid var(--line); border-radius:8px; padding:12px; min-height:120px; font-size:12px; }
      .navbtn { touch-action: manipulation; }
      /* Modal */
      .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:20px; padding-top:calc(24px + env(safe-area-inset-top, 0px)); }
      .modal-backdrop { position:absolute; inset:0; background:#000; opacity:0.92; }
      .modal-panel { position:relative; z-index:1; width:min(640px, 92vw); max-height:78vh; background:#fff; border-radius:16px; box-shadow:0 24px 70px rgba(0,0,0,0.3); display:flex; flex-direction:column; overflow:hidden; }
      .modal-head { display:flex; justify-content:space-between; align-items:center; padding:14px 18px; border-bottom:1px solid var(--line); gap:12px; }
      .modal-title { font-weight:600; font-size:14px; flex:1; min-width:0; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
      .modal-actions { display:flex; align-items:center; gap:10px; margin-left:auto; flex-shrink:0; }
      .modal-action { display:inline-flex; align-items:center; justify-content:center; padding:8px 14px; border:1px solid var(--line); border-radius:12px; background:#0f172a; color:#fff; cursor:pointer; font-size:13px; box-shadow:0 6px 16px rgba(15,23,42,0.15); }
      .modal-action i { font-size:18px; margin-right:4px; }
      .modal-action:active { transform:translateY(1px); }
      .modal-close { border:none; background:transparent; color:#111827; font-size:22px; cursor:pointer; padding:6px; line-height:1; }
      .modal-close:active { transform:translateY(1px); }
      .modal-body { position:relative; padding:16px; flex:1; overflow:auto; display:flex; align-items:center; justify-content:center; background:#f8fafc; }
      .modal-body .viewer { max-width:100%; max-height:100%; border:none; }
      .modal-body .viewer video, .modal-body .viewer img, .modal-body .viewer iframe { max-width:100%; max-height:100%; display:block; border-radius:8px; }
      .modal-body pre { width:100%; max-height:100%; overflow:auto; background:#0b1220; color:#e5e7eb; border-radius:8px; padding:12px; }
      .modal.security-modal .modal-panel { width:min(420px, 92vw); max-height:70vh; height:auto; }
      .modal.security-modal .modal-body { background:#000; padding:24px; color:#f8fafc; }
      .modal.security-modal .modal-backdrop { background:#000; opacity:1; }
      .modal.security-modal .security-message { display:flex; flex-direction:column; gap:12px; font-size:14px; color:#f8fafc; text-align:center; }
      .modal.security-modal .security-message strong { color:#38bdf8; }
      .modal.security-modal .modal-close { display:none; }
      .modal.progress-modal .modal-panel { width:min(340px, 90vw); max-height:none; background:#0f172a; color:#f8fafc; }
      .modal.progress-modal .modal-head { border-bottom:1px solid rgba(148,163,184,0.25); justify-content:center; }
      .modal.progress-modal .modal-body { background:transparent; padding:24px 28px; }
      .modal.progress-modal .modal-close { display:none; }
      .progress-wrap { width:100%; display:flex; flex-direction:column; gap:14px; }
      .progress-title { font-weight:600; font-size:15px; text-align:center; letter-spacing:0.4px; }
      .orientation-overlay { position:fixed; inset:0; background:linear-gradient(160deg,rgba(15,23,42,0.98),rgba(15,23,42,0.92)); color:#f8fafc; display:none; align-items:center; justify-content:center; flex-direction:column; gap:12px; text-align:center; padding:32px; z-index:2000; font-size:18px; line-height:1.6; letter-spacing:0.4px; }
      .orientation-overlay .icon { font-size:42px; display:block; }
      html.orientation-block { height:100%; overflow:hidden; }
      html.orientation-block body { overflow:hidden; height:100%; }
      html.orientation-block .orientation-overlay { display:flex; }
      .progress-bar { width:100%; height:12px; background:rgba(148,163,184,0.25); border-radius:999px; overflow:hidden; }
      .progress-inner { width:0%; height:100%; background:linear-gradient(90deg,#38bdf8,#0ea5e9); transition:width .2s ease; }
      .progress-text { text-align:center; font-size:13px; color:#cbd5ff; letter-spacing:0.4px; }
      .modal.folder-modal .modal-panel { width:min(360px, 92vw); max-height:none; }
      .modal.folder-modal .modal-body { background:#f8fafc; padding:22px 24px; }
      .modal.folder-modal .modal-close { display:none; }
      .folder-form { display:flex; flex-direction:column; gap:14px; width:100%; }
      .folder-form label { font-size:13px; color:#1f2937; font-weight:600; }
      .folder-form input { border:1px solid var(--line); border-radius:12px; padding:12px; font-size:14px; background:#fff; }
      .folder-hint { margin:0; font-size:12px; color:#64748b; }
      .folder-error { margin:0; font-size:12px; color:#b91c1c; min-height:16px; }
      .folder-actions { margin-top:6px; display:flex; justify-content:flex-end; gap:10px; }
      .folder-actions button { min-width:88px; }
      .modal.upload-modal .modal-panel { width:min(420px, 92vw); max-height:none; }
      .modal.upload-modal .modal-body { background:#f8fafc; padding:22px 24px; }
      .upload-form { display:flex; flex-direction:column; gap:14px; }
      .upload-field { position:relative; border:1px dashed var(--line); border-radius:14px; background:#fff; overflow:hidden; }
      .upload-input { position:absolute; inset:0; opacity:0; cursor:pointer; z-index:2; }
      .upload-callout { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; padding:22px 18px; color:#0f172a; font-size:14px; font-weight:600; pointer-events:none; }
      .upload-callout i { font-size:28px; color:#2563eb; }
      .upload-name { font-size:13px; color:#64748b; letter-spacing:0.3px; margin-top:6px; }
      .upload-hint { margin:0; font-size:12px; color:#94a3b8; }
      .upload-error { margin:0; font-size:12px; color:#b91c1c; min-height:16px; }
      .upload-actions { display:flex; justify-content:flex-end; gap:10px; }
      .upload-actions button { min-width:92px; }
      .profile-card { position:relative; padding:22px; overflow:hidden; }
      .profile-header { display:flex; align-items:flex-start; gap:18px; position:relative; }
      .profile-avatar { position:relative; width:96px; height:96px; flex:0 0 96px; border-radius:999px; overflow:visible; border:2px solid transparent; background:linear-gradient(#fff,#fff) padding-box, linear-gradient(135deg,#ff8a00,#e52e71) border-box; display:flex; align-items:center; justify-content:center; }
      .profile-avatar img { width:100%; height:100%; object-fit:cover; display:block; border-radius:inherit; cursor:pointer; }
      .profile-avatar .avatar-edit-btn { position:absolute; right:-6px; bottom:-6px; width:36px; height:36px; border-radius:999px; border:3px solid #fff; background:linear-gradient(135deg,#1f8bf0,#0c4dc7); color:#fff; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 18px rgba(12,77,199,0.35); cursor:pointer; z-index:3; }
      .profile-avatar .avatar-edit-btn i { font-size:17px; }
      .profile-avatar .avatar-edit-btn:active { transform:translateY(1px); }
      .profile-main { display:flex; flex-direction:column; gap:16px; flex:1 1 auto; }
      .profile-nickname { display:flex; flex-direction:column; gap:8px; font-size:18px; font-weight:700; color:#0f172a; letter-spacing:0.3px; }
      .profile-nickname button { border:none; background:#e2e8f0; color:#0f172a; font-size:13px; font-weight:500; border-radius:999px; padding:6px 12px; display:inline-flex; align-items:center; gap:6px; cursor:pointer; align-self:flex-start; box-shadow:none; }
      .profile-nickname button i { font-size:16px; }
      .profile-nickname button:active { transform:translateY(1px); }
      .profile-stats { display:flex; gap:12px; align-items:center; justify-content:flex-start; flex-wrap:wrap; }
      .profile-stats .stat { display:flex; flex-direction:column; gap:2px; align-items:center; min-width:72px; }
      .profile-stats .stat-value { font-size:18px; font-weight:700; color:#0f172a; }
      .profile-stats .stat-label { font-size:12px; color:#6b7280; letter-spacing:0.2px; }
      .profile-share-btn { border:none; background:linear-gradient(135deg,#38bdf8,#0ea5e9); color:#fff; border-radius:999px; width:28px; height:28px; display:inline-flex; align-items:center; justify-content:center; box-shadow:0 8px 18px rgba(14,165,233,0.2); cursor:pointer; }
      .profile-share-btn i { font-size:14px; }
      .profile-share-btn:active { transform:translateY(1px); }
      .modal.nickname-modal .modal-panel { width:min(360px, 92vw); background:#fff; color:#0f172a; }
      .nickname-form { display:flex; flex-direction:column; gap:14px; }
      .nickname-form label { font-size:14px; color:#0f172a; font-weight:600; }
      .nickname-form input { border:1px solid #dbe3f3; border-radius:12px; padding:10px 12px; font-size:15px; }
      .nickname-form input:focus { outline:none; border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,0.18); }
      .nickname-hint { margin:0; font-size:12px; color:#64748b; line-height:1.5; }
      .nickname-actions { display:flex; justify-content:flex-end; gap:10px; }
      .qr-placeholder {
        width:100%;
        height:240px;
        display:flex;
        align-items:center;
        justify-content:center;
        color:#cbd5f5;
        font-size:13px;
      }
      .hidden { display:none !important; }
      .contact-list { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:10px; }
      .contact-list-header { font-size:13px; color:#64748b; padding:12px 4px 6px 4px; }
      .contact-list-header strong { font-size:15px; color:#0f172a; font-weight:700; margin-right:4px; }
      body.modal-open .profile-share-btn { pointer-events:none; opacity:0.75; }
      .messages-pane { display:flex; flex-direction:column; gap:0; border:1px solid transparent; border-radius:0; overflow:hidden; background:#fff; min-height:60vh; box-shadow:none; width:100%; }
      #tab-messages .messages-pane { height:100%; min-height:0; }
      .messages-body { display:flex; flex:1 1 auto; min-height:0; overflow:hidden; }
      .messages-sidebar { width:180px; max-width:40%; border-right:1px solid var(--line); background:#f8fafc; display:flex; flex-direction:column; }
      .conversation-list { list-style:none; margin:0; padding:0 0 12px; display:flex; flex-direction:column; }
      .conversation-item { position:relative; display:flex; align-items:stretch; }
      .conversation-item .item-content { display:flex; align-items:center; gap:12px; padding:14px 18px; width:100%; cursor:pointer; transition:background .18s ease, color .18s ease; border-left:3px solid transparent; }
      .conversation-item.disabled .item-content { opacity:0.45; cursor:not-allowed; filter:grayscale(0.3); }
      .conversation-item:not(.disabled) .item-content:hover { background:#e2e8f0; }
      .conversation-item.active .item-content { background:#dbeafe; border-left-color:#2563eb; color:#0f172a; }
      .conversation-avatar { width:44px; height:44px; border-radius:50%; background:#cbd5f5; color:#fff; display:flex; align-items:center; justify-content:center; font-size:15px; font-weight:600; overflow:hidden; text-transform:uppercase; }
      .conversation-avatar img { width:100%; height:100%; object-fit:cover; display:block; }
      .conversation-content { flex:1; min-width:0; display:flex; flex-direction:column; gap:6px; }
      .conversation-row { display:flex; align-items:center; gap:12px; }
      .conversation-row-top { justify-content:space-between; }
      .conversation-row-bottom { justify-content:space-between; }
      .conversation-name { flex:1; font-size:14px; font-weight:600; color:#0f172a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
      .conversation-time { flex:0 0 auto; font-size:12px; color:#94a3b8; text-align:right; min-width:52px; }
      .conversation-snippet { flex:1; font-size:12px; color:#64748b; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
      .conversation-badge { flex:0 0 auto; min-width:22px; padding:2px 6px; border-radius:999px; background:linear-gradient(135deg,#2563eb,#1d4ed8); color:#fff; font-size:11px; font-weight:600; text-align:center; line-height:1; align-self:flex-start; box-shadow:0 4px 12px rgba(37,99,235,0.25); }
      .conversation-badge-small { align-self:center; min-width:20px; font-size:10px; }
      .conversation-item .item-delete { position:absolute; top:0; right:0; bottom:0; width:72px; border:none; background:#ef4444; color:#fff; display:flex; align-items:center; justify-content:center; font-size:22px; cursor:pointer; pointer-events:none; opacity:0; transition:opacity .18s ease; z-index:2; }
      .conversation-item.show-delete .item-delete { pointer-events:auto; opacity:1; }
      .conversation-item.show-delete .item-content { transform:translateX(-72px); pointer-events:none; }
      .conversation-item.show-delete .conversation-content { pointer-events:none; }
      .conversation-item.show-delete .conversation-item-content,
      .conversation-item.show-delete .conversation-item-content * { pointer-events:none !important; }
      .conversation-item.active .conversation-name { color:#0f172a; }
      .conversation-item.active .conversation-time { color:#2563eb; }
      .conversation-empty { width:100%; text-align:center; color:#94a3b8; font-size:13px; padding:12px 0; }
      .messages-thread { flex:1 1 auto; display:flex; flex-direction:column; min-width:0; min-height:0; margin:0; }
      .messages-header { flex:0 0 auto; padding:12px 16px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:12px; }
      .messages-header-meta { display:flex; flex-direction:column; gap:4px; min-width:0; }
      .messages-header strong { font-size:17px; letter-spacing:0.3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
      .messages-header span.status { font-size:12px; color:#64748b; }
      .messages-back { display:none; align-items:center; justify-content:center; width:38px; height:38px; border-radius:14px; border:1px solid var(--line); background:#fff; color:#0f172a; box-shadow:0 4px 12px rgba(15,23,42,0.08); }
      .messages-back i { font-size:20px; line-height:1; }
      .messages-scroll { flex:1 1 auto; overflow-y:auto; padding:18px; display:flex; flex-direction:column; gap:12px; background:#f8fafc; }
      .messages-pane.is-desktop .messages-back { display:inline-flex; }
      .messages-pane.is-desktop .messages-body { flex:1 1 auto; min-height:0; }
      .messages-pane.is-desktop .messages-thread { flex:1 1 auto; min-height:0; }
      .messages-pane.is-desktop .messages-scroll { flex:1 1 auto; }
      .messages-list { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:12px; }
      .message-row { display:flex; align-items:flex-end; gap:8px; }
      .message-avatar { width:38px; height:38px; border-radius:50%; overflow:hidden; background:#e2e8f0; display:flex; align-items:center; justify-content:center; font-size:14px; color:#64748b; flex-shrink:0; }
      .message-avatar img { width:100%; height:100%; object-fit:cover; display:block; }
      .messages-load-more { align-self:center; margin:0 auto 12px; padding:6px 14px; border-radius:12px; border:1px solid rgba(148,163,184,0.4); background:#fff; color:#475569; font-size:12px; box-shadow:0 4px 12px rgba(15,23,42,0.08); display:flex; align-items:center; gap:10px; }
      .messages-load-more .spinner { width:16px; height:16px; border-radius:50%; border:2px solid rgba(148,163,184,0.35); border-top-color:#2563eb; animation:modal-spin .9s linear infinite; display:none; }
      .messages-load-more.loading .spinner { display:inline-block; }
      .messages-load-more.hidden { display:none; }
      .message-bubble { max-width:82%; padding:10px 14px; border-radius:16px; font-size:14px; line-height:1.5; color:#0f172a; box-shadow:0 6px 18px rgba(15,23,42,0.08); word-wrap:break-word; }
      .message-bubble.message-file { padding:12px 14px; display:flex; flex-direction:column; gap:10px; cursor:pointer; }
      .message-file-body { display:flex; align-items:center; gap:12px; text-align:left; }
      .message-file-icon { width:40px; height:40px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:20px; flex-shrink:0; background:rgba(15,23,42,0.1); color:#0f172a; }
      .message-me .message-file-icon { background:rgba(255,255,255,0.25); color:#fff; }
      .message-file-info { flex:1 1 auto; min-width:0; }
      .message-file-name { font-weight:600; font-size:14px; word-break:break-word; }
      .message-me .message-file-name { color:#fff; }
      .message-file-meta { font-size:12px; color:#64748b; opacity:0.9; }
      .message-me .message-file-meta { color:rgba(255,255,255,0.85); }
      .message-file-download { border:none; border-radius:12px; padding:6px 14px; font-size:12px; cursor:pointer; background:rgba(15,23,42,0.08); color:#0f172a; transition:background .18s ease; }
      .message-file-download:disabled { opacity:0.6; cursor:wait; }
      .message-me .message-file-download { background:rgba(255,255,255,0.24); color:#fff; }
      .message-file-progress { font-size:12px; color:#64748b; text-align:right; }
      .message-me .message-file-progress { color:rgba(255,255,255,0.85); }
      .message-file-error { color:#dc2626 !important; }
      .message-file-preview { margin-top:8px; border-radius:12px; background:rgba(15,23,42,0.04); padding:12px; display:flex; justify-content:center; align-items:center; min-height:80px; position:relative; overflow:hidden; text-align:center; font-size:12px; color:#475569; }
      .message-me .message-file-preview { background:rgba(255,255,255,0.18); color:rgba(255,255,255,0.9); }
      .message-file-preview-image { max-width:220px; max-height:220px; border-radius:12px; box-shadow:0 10px 30px rgba(15,23,42,0.25); }
      .message-file-preview-video { width:220px; max-width:100%; border-radius:12px; background:#000; box-shadow:0 12px 36px rgba(15,23,42,0.35); }
      .message-file-preview-pdf { width:240px; height:180px; border:none; border-radius:12px; background:#eef2ff; box-shadow:0 10px 24px rgba(15,23,42,0.18); }
      .message-file-actions { margin-top:8px; display:flex; gap:8px; justify-content:flex-end; }
      .message-file-preview-btn { border:none; border-radius:12px; padding:6px 14px; font-size:12px; cursor:pointer; background:rgba(15,23,42,0.08); color:#0f172a; transition:background .18s ease; }
      .message-file-preview-btn:disabled { opacity:0.6; cursor:wait; }
      .message-me .message-file-preview-btn { background:rgba(255,255,255,0.24); color:#fff; }
      .message-file-preview[data-preview-state="loading"] { color:#64748b; }
      .message-file-preview[data-preview-state="error"] { color:#dc2626; }
      .message-file-preview[data-preview-state="unsupported"] { color:#64748b; }
      .message-me { margin-left:auto; background:linear-gradient(135deg,#38bdf8,#0ea5e9); color:#fff; border-bottom-right-radius:4px; }
      .message-peer { margin-right:auto; background:#fff; border:1px solid rgba(15,23,42,0.08); border-bottom-left-radius:4px; }
      .message-meta { margin-top:6px; font-size:11px; color:#64748b; text-align:right; }
      .messages-empty { color:#94a3b8; text-align:center; font-size:14px; padding:40px 12px; }
      .messages-composer { flex:0 0 auto; display:flex; flex-direction:row; flex-wrap:nowrap; align-items:center; gap:8px; padding:10px 14px; border-top:1px solid var(--line); background:#fff; }
      .composer-attach { flex:0 0 44px; width:44px; height:44px; border-radius:16px; border:1px solid rgba(148,163,184,0.35); background:#f8fafc; color:#0f172a; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 12px rgba(15,23,42,0.08); }
      .composer-attach i { font-size:20px; }
      .messages-composer textarea { flex:1 1 auto; min-width:0; resize:none; border:1px solid rgba(148,163,184,0.6); border-radius:16px; padding:10px 14px; font-size:14px; min-height:44px; max-height:120px; }
      .composer-send { flex:0 0 44px; width:44px; height:44px; border-radius:16px; border:none; background:linear-gradient(135deg,#2563eb,#1d4ed8); color:#fff; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 24px rgba(37,99,235,0.28); }
      .composer-send i { font-size:20px; }
      @media (max-width: 959px) {
        #tab-messages { padding:0; }
        .messages-pane { border:none; border-radius:0; min-height:calc(100vh - 140px); box-shadow:none; background:#fff; }
        .messages-body { flex-direction:column; }
        .messages-sidebar { width:100%; max-width:none; border-right:none; border-bottom:1px solid var(--line); }
        .messages-sidebar h3 { margin:14px 18px; }
        .messages-pane.list-view .messages-thread { display:none; }
        .messages-pane.detail-view .messages-sidebar { display:none; }
        .messages-pane.detail-view { overflow:hidden; }
        .messages-pane.detail-view .messages-thread { display:flex; }
        .messages-pane.detail-view .messages-back { display:inline-flex; }
        .messages-pane.list-view .messages-back { display:none; }
        .messages-thread { min-height:calc(100vh - 208px); overflow:hidden; margin:0; }
        .messages-header { padding:12px 16px; }
        .messages-scroll { padding:16px; }
        .messages-composer { padding:10px 12px; }
      }
      @media (max-width: 600px) {
        .profile-card { padding:18px; }
        .profile-header { flex-direction:column; align-items:center; gap:16px; }
        .profile-avatar { width:88px; height:88px; flex:0 0 88px; }
        .profile-avatar .avatar-edit-btn { right:-4px; bottom:-4px; width:32px; height:32px; }
        .profile-main { align-items:center; gap:14px; text-align:center; }
        .profile-nickname { align-items:center; }
        .profile-nickname button { align-self:center; }
        .profile-stats { justify-content:center; gap:10px; }
      }
      .modal.avatar-modal .modal-panel { width:min(360px, 92vw); background:#fff; color:#0f172a; max-height:80vh; display:flex; flex-direction:column; }
      .modal.avatar-modal .modal-body { overflow:auto; padding-right:12px; }
      .avatar-upload { display:flex; flex-direction:column; gap:16px; }
      .avatar-preview { width:160px; height:160px; border-radius:24px; background:#e2e8f0; margin:0 auto; overflow:hidden; display:flex; align-items:center; justify-content:center; position:relative; }
      .avatar-preview canvas, .avatar-preview img { width:100%; height:100%; display:block; border-radius:inherit; }
      .avatar-preview::after { content:'預覽'; position:absolute; inset:auto auto 10px auto; font-size:12px; color:#fff; background:rgba(15,23,42,0.45); padding:2px 8px; border-radius:999px; letter-spacing:0.2px; }
      .avatar-select { display:flex; justify-content:center; }
      .avatar-select button { padding:8px 18px; border-radius:14px; background:#0ea5e9; color:#fff; border:none; cursor:pointer; box-shadow:0 8px 16px rgba(14,165,233,0.25); }
      .avatar-select button:active { transform:translateY(1px); }
      .avatar-hint { margin:0; font-size:12px; color:#64748b; text-align:center; }
      .avatar-actions { display:flex; justify-content:flex-end; gap:10px; }
      .avatar-controls { display:flex; flex-direction:column; gap:8px; }
      .avatar-controls label { font-size:12px; color:#0f172a; display:flex; flex-direction:column; gap:6px; }
      .avatar-controls input[type="range"] { width:100%; accent-color:#0ea5e9; }
      .avatar-controls input[disabled] { opacity:0.4; }
      .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
      .share-modal { z-index:1600; }
      .share-modal-panel { position:relative; width:min(420px, 92vw); max-width:420px; height:min(520px, 85vh); max-height:85vh; background:transparent; border-radius:24px; box-shadow:none; display:block; overflow:visible; perspective:1600px; }
      .share-flip { position:relative; width:100%; height:100%; transform-style:preserve-3d; transition:transform .72s cubic-bezier(.21,.65,.43,1); }
      .share-flip.flipped { transform:rotateY(180deg); }
      .share-face { position:absolute; inset:0; display:flex; flex-direction:column; backface-visibility:hidden; border-radius:24px; overflow:hidden; box-shadow:0 30px 70px rgba(15,23,42,0.28); }
      .share-face.share-front { background:#ffffff; color:#0f172a; }
      .share-face.share-back { background:#040b1a; color:#f8fafc; transform:rotateY(180deg); }
      .share-head { position:relative; padding:24px 24px 12px; display:flex; flex-direction:column; gap:12px; justify-content:flex-start; }
      .share-head-content { display:flex; flex-direction:column; gap:8px; max-width:calc(100% - 130px); }
      .share-title { font-size:18px; font-weight:700; letter-spacing:0.4px; }
      .share-countdown { display:flex; justify-content:center; width:100%; }
      #inviteCountdown { display:inline-flex; align-items:center; justify-content:center; min-height:30px; padding:6px 16px; border-radius:999px; background:#f1f5f9; box-shadow:inset 0 0 0 1px rgba(15,23,42,0.1); color:#0f172a; font-size:12px; letter-spacing:0.4px; }
      .share-face.share-back .share-countdown { display:none; }
      #inviteCountdown:empty { display:none; }
      .share-close { position:absolute; top:18px; left:18px; width:32px; height:32px; border:none; border-radius:50%; background:rgba(15,23,42,0.08); color:inherit; font-size:20px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:transform .2s ease, opacity .2s ease; }
      .share-close:active { transform:scale(0.94); }
      .share-face.share-back .share-close { background:rgba(248,250,252,0.18); color:#f8fafc; }
      .share-corner-toggle { position:absolute; top:0; right:0; width:112px; height:62px; border:none; display:flex; align-items:flex-start; justify-content:flex-end; padding:12px 16px; cursor:pointer; clip-path:polygon(24% 0,100% 0,100% 100%,0 100%); transition:transform .2s ease, box-shadow .2s ease; border-radius:0; }
      .share-corner-toggle:active { transform:scale(0.96); }
      .share-corner-toggle--scan { background:linear-gradient(135deg,#2563eb,#3b82f6); color:#fff; box-shadow:0 14px 28px rgba(37,99,235,0.35); justify-content:center; align-items:center; }
      .share-corner-toggle--scan i { font-size:24px; }
      .share-corner-toggle--qr { background:linear-gradient(135deg,rgba(15,23,42,0.92),rgba(15,23,42,0.78)); color:#f8fafc; box-shadow:0 14px 32px rgba(4,11,26,0.45); }
      .share-corner-qr { position:relative; display:block; width:34px; height:34px; background:#f8fafc; border-radius:6px; box-shadow:inset 0 0 0 3px rgba(15,23,42,0.7); }
      .share-corner-qr::before, .share-corner-qr::after { content:''; position:absolute; width:10px; height:10px; background:#040b1a; }
      .share-corner-qr::before { top:5px; left:5px; box-shadow:0 14px 0 0 #040b1a, 14px 0 0 0 #040b1a; }
      .share-corner-qr::after { bottom:5px; right:5px; box-shadow:-14px 0 0 0 #040b1a; }
      .share-body { flex:1; display:flex; padding:12px 24px 24px; }
      .share-body-qr { flex-direction:column; align-items:center; justify-content:center; gap:18px; }
      .share-qr-box { width:100%; max-width:270px; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; border-radius:24px; background:linear-gradient(160deg,#f8fafc,#e0ecff); box-shadow:0 18px 36px rgba(15,23,42,0.16); overflow:hidden; }
      .share-qr-box canvas { width:100%; height:100%; }
      .share-qr-box .qr-placeholder { width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#64748b; font-size:13px; text-align:center; line-height:1.6; padding:12px; }
      .share-body-scan { position:relative; flex:1; border-radius:28px 28px 0 0; overflow:hidden; background:#020617; }
      .share-scan-video { width:100%; height:100%; object-fit:cover; }
      .share-scan-status { position:absolute; left:50%; bottom:20px; transform:translateX(-50%); padding:10px 18px; border-radius:999px; background:rgba(15,23,42,0.72); color:#f8fafc; font-size:13px; letter-spacing:0.3px; text-align:center; max-width:85%; }
      .preview-wrap { width:100%; display:flex; flex-direction:column; gap:16px; }
      .modal.loading-modal .modal-panel { width:min(320px, 80vw); background:#0f172a; color:#f8fafc; }
      .modal.loading-modal .modal-head { display:none; }
      .modal.loading-modal .modal-body { background:transparent; padding:32px 28px; }
      .loading-wrap { display:flex; flex-direction:column; align-items:center; gap:12px; }
      .loading-spinner { width:36px; height:36px; border-radius:50%; border:4px solid rgba(148,163,184,0.25); border-top-color:#38bdf8; animation:modal-spin .9s linear infinite; }
      .loading-text { font-size:13px; letter-spacing:0.3px; }
      @keyframes modal-spin { to { transform:rotate(360deg); } }
      .modal.confirm-modal .modal-panel { width:min(360px, 92vw); max-height:none; }
      .modal.confirm-modal .modal-body { background:#fff; padding:24px 24px 20px; display:flex; flex-direction:column; gap:16px; }
      .confirm-message { font-size:14px; color:#1f2937; line-height:1.6; }
      .confirm-actions { display:flex; justify-content:flex-end; gap:10px; }
      .btn-danger { background:#ef4444; color:#fff; border:1px solid #ef4444; padding:8px 16px; border-radius:12px; cursor:pointer; box-shadow:0 6px 16px rgba(239,68,68,0.25); }
      .btn-danger:active { transform:translateY(1px); }
      .toast { position:fixed; top:calc(12px + env(safe-area-inset-top, 0px)); left:50%; transform:translateX(-50%); z-index:5000; background:#fff; border-radius:16px; padding:10px 14px; box-shadow:0 12px 28px rgba(15,23,42,0.18); display:none; align-items:center; gap:10px; max-width:300px; width:calc(100vw - 56px); border:1px solid rgba(148,163,184,0.2); max-height:64px; }
      @media (min-width: 420px) { .toast { max-width:340px; } }
      .toast.show { display:flex; }
      .toast-avatar { width:32px; height:32px; border-radius:50%; overflow:hidden; flex-shrink:0; background:#e2e8f0; display:flex; align-items:center; justify-content:center; font-size:12px; color:#64748b; }
      .toast-avatar img { width:100%; height:100%; object-fit:cover; display:block; }
      .toast-body { flex:1; display:flex; flex-direction:column; gap:2px; }
      .toast-text { font-size:13px; color:#0f172a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
      .toast-sub { font-size:11px; color:#64748b; }
      .message-separator { display:flex; justify-content:center; align-items:center; margin:12px 0; font-size:12px; color:#9ca3af; letter-spacing:0.3px; background:transparent; text-align:center; }
      .modal.settings-modal .modal-panel { width:min(360px, 92vw); max-height:none; }
      .modal.settings-modal .modal-body { background:#fff; padding:24px 24px 20px; display:flex; flex-direction:column; gap:20px; }
      .settings-form { display:flex; flex-direction:column; gap:18px; }
      .settings-item { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
      .settings-item .settings-text { flex:1; }
      .settings-item strong { display:block; font-size:15px; color:#0f172a; letter-spacing:0.2px; }
      .settings-item p { margin:4px 0 0; font-size:12px; color:#64748b; line-height:1.5; }
      .settings-actions { display:flex; justify-content:flex-end; gap:10px; }
      .settings-actions button { min-width:88px; }
      .settings-switch { position:relative; display:inline-flex; align-items:center; justify-content:flex-start; cursor:pointer; user-select:none; }
      .settings-switch input { position:absolute; inset:0; opacity:0; margin:0; cursor:pointer; }
      .settings-switch .switch-track { width:46px; height:26px; border-radius:999px; background:#cbd5f5; display:inline-flex; align-items:center; padding:3px; transition:background .2s ease; }
      .settings-switch .switch-thumb { width:20px; height:20px; border-radius:50%; background:#fff; box-shadow:0 2px 6px rgba(15,23,42,0.18); transition:transform .2s ease; transform:translateX(0); }
      .settings-switch input:checked + .switch-track { background:#38bdf8; }
      .settings-switch input:checked + .switch-track .switch-thumb { transform:translateX(20px); }
      .settings-switch input:focus-visible + .switch-track { box-shadow:0 0 0 3px rgba(56,189,248,0.35); }
      main.content.security-locked { pointer-events:none; filter:grayscale(.4); opacity:.6; }
    </style>
  </head>
  <body>
    <div id="orientationOverlay" class="orientation-overlay" aria-hidden="true">
      <span class="icon" aria-hidden="true">📱</span>
      <strong>請以直立模式使用</strong>
      <span>為確保最佳體驗，請將裝置轉回直立方向。</span>
    </div>
    <header class="topbar">
      <div class="title">
        <img class="brand" src="/assets/images/logo.svg" alt="SENTRY MESSENGER" />
        <span>SENTRY</span>
        <span id="connectionIndicator" class="connection-indicator" aria-live="polite" data-ws-path="/api/ws" data-ws-host="api.message.sentry.red"><span class="dot" aria-hidden="true"></span>離線</span>
      </div>
      <div class="actions">
        <div id="userMenu" class="user-menu">
          <button id="btnUserMenu" class="user-avatar-btn" type="button" aria-haspopup="true" aria-expanded="false" aria-label="開啟使用者選單">
            <img id="headerAvatarImg" src="/assets/images/avatar.png" alt="使用者頭像" />
          </button>
          <div id="userMenuDropdown" class="user-menu-dropdown" role="menu" aria-hidden="true">
            <button class="user-menu-item" type="button" data-action="settings" role="menuitem">系統設定</button>
            <div class="user-menu-divider" role="presentation"></div>
            <button class="user-menu-item logout" type="button" data-action="logout" role="menuitem">登出</button>
          </div>
        </div>
      </div>
    </header>

    <main class="content">
      <section id="tab-contacts" class="tab">
        <div class="card contacts-card">
          <div id="contactsScroll" class="contacts-scroll">
            <div id="contactsRefreshHint" class="contacts-refresh">
              <i class='bx bx-refresh icon' aria-hidden="true"></i>
              <span class="label">下拉更新聯絡人</span>
            </div>
            <div class="contact-list-header"><strong id="contactsCount">0</strong> 個好友</div>
            <ul id="contactsList" class="contact-list"></ul>
          </div>
        </div>
      </section>
      <section id="tab-messages" class="tab">
        <div class="messages-pane">
          <div class="messages-body">
            <aside class="messages-sidebar">
              <ul id="conversationList" class="conversation-list"></ul>
            </aside>
      <div class="messages-thread">
              <div class="messages-header">
                <button id="messagesBackBtn" type="button" class="messages-back hidden" aria-label="返回對話列表"><i class='bx bx-chevron-left'></i></button>
                <div id="messagesPeerAvatar" class="messages-peer-avatar"></div>
                <div class="messages-header-meta">
                  <strong id="messagesPeerName">選擇好友開始聊天</strong>
                  <span id="messagesStatus" class="status"></span>
                </div>
              </div>
              <div id="messagesScroll" class="messages-scroll">
                <div id="messagesLoadMore" class="messages-load-more hidden" role="status">
                  <span class="label">載入更多</span>
                  <span class="spinner" aria-hidden="true"></span>
                </div>
                <div id="messagesEmpty" class="messages-empty">尚未選擇任何對話</div>
                <ul id="messagesList" class="messages-list"></ul>
              </div>
              <form id="messageComposer" class="messages-composer">
                <button id="composerAttach" type="button" class="composer-attach" aria-label="附加檔案"><i class='bx bx-paperclip'></i></button>
                <input id="messageFileInput" type="file" class="sr-only" style="display:none" />
                <textarea id="messageInput" placeholder="輸入訊息…" rows="1" maxlength="1024"></textarea>
                <button id="messageSend" type="submit" class="composer-send" aria-label="送出訊息"><i class='bx bx-send'></i></button>
              </form>
            </div>
          </div>
        </div>
      </section>
      <section id="tab-drive" class="tab">
        <div class="card">
          <div class="list-header">
            <div style="display:flex;flex-direction:column;gap:6px;">
              <h3 style="margin:0">檔案列表</h3>
              <nav id="driveCrumb" class="crumb" style="font-size:13px"></nav>
            </div>
            <div class="list-actions">
              <button id="btnUploadOpen" type="button" class="secondary" aria-label="上傳檔案" title="上傳檔案"><i class='bx bx-cloud-upload'></i></button>
              <button id="btnNewFolder" type="button" class="secondary" aria-label="新建資料夾" title="新建資料夾"><i class='bx bx-folder-plus'></i></button>
              <button id="btnUp" type="button" class="secondary" style="display:none" aria-label="上一層" title="上一層"><i class='bx bx-chevron-up'></i></button>
            </div>
          </div>
          <ul id="driveList" class="list"></ul>
        </div>
      </section>
      <section id="tab-profile" class="tab">
        <div class="card profile-card">
          <div class="profile-header">
            <div class="profile-avatar">
              <img id="profileAvatarImg" src="/assets/images/avatar.png" alt="Avatar" />
              <button id="btnProfileEdit" class="avatar-edit-btn" type="button" aria-label="編輯頭像"><i class='bx bx-camera'></i></button>
            </div>
            <div class="profile-main">
              <div class="profile-nickname">
                <strong id="profileNickname">……</strong>
                <button id="btnProfileNickEdit" class="profile-edit-btn" type="button" aria-label="編輯暱稱">
                  <i class='bx bx-pencil'></i>
                  <span>修改暱稱</span>
                </button>
              </div>
              <div class="profile-stats">
                <div class="stat">
                  <div id="statContacts" class="stat-value">0</div>
                  <div class="stat-label">好友</div>
                </div>
                <button id="btnShareModal" class="profile-share-btn" type="button" aria-label="新增好友" title="新增好友">
                  <i class='bx bx-user-plus'></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Share Modal -->
    <div id="shareModal" class="modal share-modal" aria-hidden="true" style="display:none">
      <div class="modal-backdrop" data-share-close></div>
      <div class="modal-panel share-modal-panel" role="dialog" aria-modal="true" aria-labelledby="shareModalTitle">
        <div id="shareFlip" class="share-flip">
          <div class="share-face share-front">
            <span id="shareModalTitle" class="sr-only">好友分享</span>
            <header class="share-head">
              <button type="button" class="share-close" data-share-close-btn aria-label="關閉">×</button>
              <button id="btnShareSwitchScan" class="share-corner-toggle share-corner-toggle--scan" type="button" aria-label="切換為掃描模式">
                <i class='bx bx-camera' aria-hidden="true"></i>
              </button>
            </header>
            <div class="share-body share-body-qr">
              <div class="share-countdown"><span id="inviteCountdown"></span></div>
              <div id="inviteQrBox" class="share-qr-box"></div>
            </div>
          </div>
          <div class="share-face share-back">
            <header class="share-head">
              <button type="button" class="share-close" data-share-close-btn aria-label="關閉">×</button>
              <button id="btnShareSwitchQr" class="share-corner-toggle share-corner-toggle--qr" type="button" aria-label="切換回 QR 模式">
                <span class="share-corner-qr" aria-hidden="true"></span>
              </button>
            </header>
            <div class="share-body share-body-scan">
              <video id="inviteScanVideo" class="share-scan-video" muted playsinline></video>
              <div id="inviteScanStatus" class="share-scan-status"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Preview -->
    <div id="modal" class="modal" aria-hidden="true" style="display:none">
      <div class="modal-backdrop" id="modalCloseArea"></div>
      <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-head">
          <div id="modalTitle" class="modal-title">Preview</div>
          <div class="modal-actions">
            <button id="modalDownload" type="button" class="modal-action" style="display:none" aria-label="下載">
              <i class='bx bx-download'></i><span>下載</span>
            </button>
            <button id="modalClose" class="modal-close" aria-label="Close">×</button>
          </div>
        </div>
        <div id="modalBody" class="modal-body"></div>
      </div>
    </div>

    <div id="appToast" class="toast" role="status" aria-live="polite"></div>

    <nav class="navbar">
      <button id="nav-contacts" class="navbtn" aria-label="聯絡人">
        <span class="nav-badge" data-tab="contacts"></span>
        <i class='bx bx-user-circle' style="font-size:22px"></i>
        <span>聯絡人</span>
      </button>
      <button id="nav-messages" class="navbtn" aria-label="訊息">
        <span class="nav-badge" data-tab="messages"></span>
        <i class='bx bx-message-dots' style="font-size:22px"></i>
        <span>訊息</span>
      </button>
      <button id="nav-drive" class="navbtn active" aria-label="雲端硬碟">
        <span class="nav-badge" data-tab="drive"></span>
        <i class='bx bx-folder' style="font-size:22px"></i>
        <span>雲端硬碟</span>
      </button>
      <button id="nav-profile" class="navbtn" aria-label="我的檔案">
        <span class="nav-badge" data-tab="profile"></span>
        <i class='bx bx-user' style="font-size:22px"></i>
        <span>我的檔案</span>
      </button>
    </nav>

    <script>
      window.API_ORIGIN = 'https://api.message.sentry.red';
      (function(){
        const overlay = document.getElementById('orientationOverlay');
        const docEl = document.documentElement;
        const mq = window.matchMedia('(orientation: portrait)');
        const isMobileLike = () => {
          const touch = navigator.maxTouchPoints || navigator.msMaxTouchPoints || 0;
          const shortEdge = Math.min(window.innerWidth, window.innerHeight);
          const ua = navigator.userAgent || '';
          const looksMobileUA = /iPhone|iPad|Android|Mobile/i.test(ua);
          return shortEdge <= 1024 && (touch > 0 || looksMobileUA);
        };
        function update(){
          if (!isMobileLike()) {
            docEl.classList.remove('orientation-block');
            if (overlay) overlay.setAttribute('aria-hidden','true');
            return;
          }
          const portrait = mq.matches || window.innerHeight >= window.innerWidth;
          if (portrait) {
            docEl.classList.remove('orientation-block');
            if (overlay) overlay.setAttribute('aria-hidden','true');
          } else {
            docEl.classList.add('orientation-block');
            if (overlay) overlay.setAttribute('aria-hidden','false');
          }
        }
        if (mq.addEventListener) mq.addEventListener('change', update); else mq.addListener(update);
        window.addEventListener('orientationchange', update);
        window.addEventListener('resize', update);
        update();
        if (screen.orientation && screen.orientation.lock && isMobileLike()) {
          screen.orientation.lock('portrait').catch(() => {});
        }
      })();
    </script>
    <script type="module" src="/app/ui/app-mobile.js?v=3"></script>
  </body>
</html>

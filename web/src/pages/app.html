<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="color-scheme" content="light" />
  <title>SENTRY MESSENGER â€” App</title>
  <link rel="icon" href="/assets/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="/assets/styles.css" />
  <!-- Icons: Boxicons -->
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/profile-extra.css" />
  <link rel="stylesheet" href="/assets/cropper.css" />
  <script>
    // é˜²æ­¢æœªåˆå§‹åŒ–æ™‚çš„å…¨åŸŸ ReferenceErrorï¼ˆSafari æœƒå›  inviteBtn æœªå®£å‘Šè€Œä¸­æ–·ï¼‰
    if (typeof inviteBtn === 'undefined') {
      // eslint-disable-next-line no-var
      var inviteBtn = null;
    }
  </script>
  <script>
    window.APP_VERSION = '0.1.21-atomic-fix';
    window.APP_BUILD_AT = (function () { try { return new Date(document.lastModified).toISOString(); } catch { return new Date().toISOString(); } })();
  </script>
  <link rel="stylesheet" href="/assets/app-base.css" />
  <link rel="stylesheet" href="/assets/app-layout.css" />
  <link rel="stylesheet" href="/assets/app-subscription.css" />
  <link rel="stylesheet" href="/assets/app-contacts.css" />
  <link rel="stylesheet" href="/assets/app-drive.css" />
  <link rel="stylesheet" href="/assets/app-modals.css" />
  <link rel="stylesheet" href="/assets/app-messages.css" />
  <link rel="stylesheet" href="/assets/app-profile.css" />
  <link rel="stylesheet" href="/assets/app-share.css" />
</head>

<body>
  <div id="orientationOverlay" class="orientation-overlay" aria-hidden="true">
    <span class="icon" aria-hidden="true">ğŸ“±</span>
    <strong>è«‹ä»¥ç›´ç«‹æ¨¡å¼ä½¿ç”¨</strong>
    <span>ç‚ºç¢ºä¿æœ€ä½³é«”é©—ï¼Œè«‹å°‡è£ç½®è½‰å›ç›´ç«‹æ–¹å‘ã€‚</span>
  </div>
  <header class="topbar">
    <div class="title">
      <img class="brand" src="/assets/images/logo.svg" alt="SENTRY MESSENGER" />
      <span>SENTRY</span>
      <span id="connectionIndicator" class="connection-indicator" aria-live="polite" data-ws-path="/api/ws"
        data-ws-host="api.message.sentry.red"><span class="dot" aria-hidden="true"></span>é›¢ç·š</span>
    </div>
    <div class="actions">
      <div id="userMenu" class="user-menu">
        <button id="btnUserMenu" class="user-avatar-btn" type="button" aria-haspopup="true" aria-expanded="false"
          aria-label="é–‹å•Ÿä½¿ç”¨è€…é¸å–®">
          <span class="user-avatar-wrap" id="userAvatarWrap">
            <img id="headerAvatarImg" src="/assets/images/avatar.png" alt="ä½¿ç”¨è€…é ­åƒ" />
            <span class="user-menu-badge" id="userMenuBadge" aria-hidden="true">!</span>
          </span>
        </button>
        <div id="userMenuDropdown" class="user-menu-dropdown" role="menu" aria-hidden="true">
          <button class="user-menu-item" type="button" data-action="settings" role="menuitem">ç³»çµ±è¨­å®š</button>
          <button class="user-menu-item" type="button" data-action="subscription" id="userMenuSubscriptionBtn"
            role="menuitem">
            <span>è¨‚é–±ç‹€æ…‹</span>
            <span class="menu-item-badge" aria-hidden="true">!</span>
          </button>
          <button class="user-menu-item" type="button" data-action="version-info" id="userMenuVersionBtn"
            role="menuitem">ç‰ˆæœ¬è³‡è¨Š</button>
          <div class="version-info-menu" id="versionInfoPopupAppMenu" aria-hidden="true"></div>
          <div class="user-menu-divider" role="presentation"></div>
          <button class="user-menu-item logout" type="button" data-action="logout" role="menuitem">ç™»å‡º</button>
        </div>
      </div>
    </div>
  </header>

  <main class="content">
    <section id="tab-contacts" class="tab">
      <div class="card contacts-card">
        <div id="contactsRefreshHint" class="contacts-refresh">
          <i class='bx bx-refresh icon' aria-hidden="true"></i>
          <span class="label">ä¸‹æ‹‰æ›´æ–°è¯çµ¡äºº</span>
        </div>
        <div id="contactsScroll" class="contacts-scroll">
          <div class="contact-list-header"><strong id="contactsCount">0</strong> å€‹å¥½å‹</div>
          <ul id="contactsList" class="contact-list"></ul>
        </div>
      </div>
    </section>
    <section id="tab-messages" class="tab">
      <div class="messages-pane">
        <div class="messages-body">
          <aside class="messages-sidebar">
            <div id="conversationRefresh" class="conversation-refresh">
              <i class='bx bx-refresh icon' aria-hidden="true"></i>
              <span class="label">ä¸‹æ‹‰æ›´æ–°å°è©±</span>
            </div>
            <div class="conversation-actions" style="display:none" aria-hidden="true">
              <button id="btnCreateGroup" type="button" class="secondary" aria-label="å»ºç«‹ç¾¤çµ„" title="å»ºç«‹ç¾¤çµ„">
                <i class='bx bx-group'></i> å»ºç«‹ç¾¤çµ„
              </button>
            </div>
            <div id="groupDrafts" class="conversation-group-drafts" aria-live="polite" style="display:none"
              aria-hidden="true"></div>
            <ul id="conversationList" class="conversation-list"></ul>
          </aside>
          <div class="messages-thread">
            <div class="messages-header">
              <button id="messagesBackBtn" type="button" class="messages-back hidden" aria-label="è¿”å›å°è©±åˆ—è¡¨"><i
                  class='bx bx-chevron-left'></i></button>
              <div id="messagesPeerAvatar" class="messages-peer-avatar"></div>
              <div class="messages-header-meta">
                <strong id="messagesPeerName">é¸æ“‡å¥½å‹é–‹å§‹èŠå¤©</strong>
                <span id="messagesStatus" class="status"></span>
              </div>
              <div class="messages-actions">
                <span id="messagesWsIndicator" class="connection-indicator messages-ws-indicator"
                  aria-hidden="true"><span class="dot" aria-hidden="true"></span></span>
                <button id="messagesCallBtn" type="button" class="messages-action-btn" aria-label="èªéŸ³é€šè©±" title="èªéŸ³é€šè©±"
                  disabled><i class='bx bx-phone'></i></button>
              </div>
            </div>
            <div id="messagesScroll" class="messages-scroll">
              <div id="messagesLoadMore" class="messages-load-more hidden" role="status">
                <span class="label">è¼‰å…¥æ›´å¤š</span>
                <span class="spinner" aria-hidden="true"></span>
              </div>
              <div id="messagesEmpty" class="messages-empty">å°šæœªé¸æ“‡ä»»ä½•å°è©±</div>
              <ul id="messagePlaceholders" class="messages-list messages-placeholders"></ul>
              <ul id="messagesList" class="messages-list"></ul>
            </div>
            <form id="messageComposer" class="messages-composer">
              <button id="composerAttach" type="button" class="composer-attach" aria-label="é™„åŠ æª”æ¡ˆ"><i
                  class='bx bx-paperclip'></i></button>
              <input id="messageFileInput" type="file" class="sr-only" style="display:none" />
              <textarea id="messageInput" placeholder="è¼¸å…¥è¨Šæ¯â€¦" rows="1" maxlength="1024"></textarea>
              <button id="messageSend" type="submit" class="composer-send" aria-label="é€å‡ºè¨Šæ¯"><i
                  class='bx bx-send'></i></button>
            </form>
          </div>
        </div>
      </div>
    </section>
    <section id="tab-drive" class="tab">
      <div id="driveRefreshHint" class="drive-refresh">
        <i class='bx bx-refresh icon' aria-hidden="true"></i>
        <span class="label">ä¸‹æ‹‰æ›´æ–°æª”æ¡ˆ</span>
      </div>
      <div class="drive-usage" aria-live="polite">
        <div class="drive-usage-top">
          <div class="drive-usage-label">é›²ç«¯ç©ºé–“</div>
          <div class="drive-usage-amount">
            <span id="driveUsageValue">0 B</span>
            <span id="driveUsageTotal" class="drive-usage-total">/ 3 GB</span>
          </div>
        </div>
        <div id="driveUsageProgress" class="drive-usage-bar" role="progressbar" aria-label="åŠ å¯†é›²ç«¯ä½¿ç”¨ç‡" aria-valuemin="0"
          aria-valuemax="100" aria-valuenow="0" aria-valuetext="0 B / 3 GB">
          <div id="driveUsageBar" class="drive-usage-bar-fill"></div>
        </div>
        <div class="drive-usage-meta">
          <span id="driveUsagePercent" class="drive-usage-percent">0%</span>
          <span id="driveUsageNote" class="drive-usage-note">æ­£åœ¨è¼‰å…¥æª”æ¡ˆåˆ—è¡¨â€¦</span>
        </div>
      </div>
      <div class="card">
        <div class="list-header">
          <div style="display:flex;flex-direction:column;gap:6px;">
            <h3 style="margin:0">æª”æ¡ˆåˆ—è¡¨</h3>
            <nav id="driveCrumb" class="crumb" style="font-size:13px"></nav>
          </div>
          <div class="list-actions">
            <button id="btnUp" type="button" class="secondary" style="display:none" aria-label="ä¸Šä¸€å±¤" title="ä¸Šä¸€å±¤"
              aria-live="polite">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true">
                <path d="M18 16H9V9" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M9 9L6 12" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M9 9L12 12" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            </button>
            <button id="btnUploadOpen" type="button" class="secondary" aria-label="ä¸Šå‚³æª”æ¡ˆ" title="ä¸Šå‚³æª”æ¡ˆ"><i
                class='bx bx-cloud-upload'></i></button>
            <button id="btnNewFolder" type="button" class="secondary" aria-label="æ–°å»ºè³‡æ–™å¤¾" title="æ–°å»ºè³‡æ–™å¤¾"><i
                class='bx bx-folder-plus'></i></button>
          </div>
        </div>
        <ul id="driveList" class="list"></ul>
      </div>
    </section>
    <section id="tab-profile" class="tab">
      <div class="card profile-card">
        <div class="profile-header">
          <div class="profile-avatar">
            <img id="profileAvatarImg" src="/assets/images/avatar.png" alt="Avatar" />
            <button id="btnProfileEdit" class="avatar-edit-btn" type="button" aria-label="ç·¨è¼¯é ­åƒ"><i
                class='bx bx-camera'></i></button>
          </div>
          <div class="profile-main">
            <div class="profile-nickname">
              <strong id="profileNickname">â€¦â€¦</strong>
              <button id="btnProfileNickEdit" class="profile-edit-btn" type="button" aria-label="ç·¨è¼¯æš±ç¨±">
                <i class='bx bx-pencil'></i>
                <span>ä¿®æ”¹æš±ç¨±</span>
              </button>
            </div>
            <div class="profile-stats">
              <div class="stat">
                <div id="statContacts" class="stat-value">0</div>
                <div class="stat-label">å¥½å‹</div>
              </div>
              <button id="btnShareModal" class="profile-share-btn" type="button" aria-label="æ–°å¢å¥½å‹" title="æ–°å¢å¥½å‹">
                <i class='bx bx-user-plus'></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Share Modal -->
  <div id="shareModal" class="modal share-modal" aria-hidden="true" style="display:none">
    <div class="modal-backdrop" data-share-close></div>
    <div class="modal-panel share-modal-panel" role="dialog" aria-modal="true" aria-labelledby="shareModalTitle">
      <div id="shareFlip" class="share-flip">
        <div class="share-face share-front">
          <span id="shareModalTitle" class="sr-only">å¥½å‹åˆ†äº«</span>
          <header class="share-head">
            <button type="button" class="share-close" data-share-close-btn aria-label="é—œé–‰">Ã—</button>
            <button id="btnShareSwitchScan" class="share-corner-toggle share-corner-toggle--scan" type="button"
              aria-label="åˆ‡æ›ç‚ºæƒææ¨¡å¼">
              <i class='bx bx-camera' aria-hidden="true"></i>
            </button>
          </header>
          <div class="share-body share-body-qr">
            <div class="share-countdown">
              <span id="inviteCountdown"></span>
              <button id="inviteRefreshBtn" class="invite-refresh-btn" type="button" aria-label="æ‰‹å‹•åˆ·æ–°äº¤å‹é‚€è«‹">
                <i class='bx bx-refresh' aria-hidden="true"></i>
              </button>
              <!-- inviteConsumeBtn removed: WS auto-consume is sufficient -->
              <!-- inviteRetryBtn removed: redundant with inviteRefreshBtn -->
            </div>
            <div id="inviteQrBox" class="share-qr-box"></div>
          </div>
        </div>
        <div class="share-face share-back">
          <header class="share-head">
            <button type="button" class="share-close" data-share-close-btn aria-label="é—œé–‰">Ã—</button>
            <button id="btnShareSwitchQr" class="share-corner-toggle share-corner-toggle--qr" type="button"
              aria-label="åˆ‡æ›å› QR æ¨¡å¼">
              <span class="share-corner-qr" aria-hidden="true"></span>
            </button>
          </header>
          <div class="share-body share-body-scan">
            <video id="inviteScanVideo" class="share-scan-video" muted playsinline></video>
            <div id="inviteScanStatus" class="share-scan-status"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Preview -->
  <div id="modal" class="modal" aria-hidden="true" style="display:none">
    <div class="modal-backdrop" id="modalCloseArea"></div>
    <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div id="modalTitle" class="modal-title">Preview</div>
        <div class="modal-actions">
          <button id="modalClose" class="modal-close" aria-label="Close">Ã—</button>
        </div>
      </div>
      <div id="modalBody" class="modal-body"></div>
    </div>
  </div>
  <div id="customLogoutModal" class="modal custom-logout-modal" aria-hidden="true" style="display:none">
    <div class="modal-backdrop" id="customLogoutBackdrop"></div>
    <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="customLogoutTitle">
      <div class="modal-head">
        <div id="customLogoutTitle" class="modal-title">è¨­å®šå®¢è£½åŒ–ç™»å‡ºé é¢</div>
        <button id="customLogoutClose" class="modal-close" aria-label="é—œé–‰">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="custom-logout-body">
          <p class="custom-logout-desc">åƒ…æ¥å— HTTPSï¼ˆhttps://ï¼‰ç¶²å€ï¼Œç™»å‡ºæ™‚æœƒå°å‘æ­¤é é¢ï¼Œè«‹ç¢ºèªç‚ºå¯ä¿¡ä»»çš„ç¶²å€ã€‚</p>
          <label class="custom-logout-field" for="customLogoutInput">
            HTTPS ç¶²å€
            <input type="url" id="customLogoutInput" list="customLogoutOptions" placeholder="https://example.com/logout"
              inputmode="url" autocomplete="off" spellcheck="false" />
          </label>
          <datalist id="customLogoutOptions">
            <option value="https://google.com"></option>
            <option value="https://apple.com"></option>
            <option value="https://www.cloudflare.com"></option>
            <option value="https://www.mozilla.org"></option>
            <option value="https://www.wikipedia.org"></option>
          </datalist>
          <div id="customLogoutError" class="custom-logout-error" role="status" aria-live="polite"></div>
          <div class="custom-logout-actions">
            <button type="button" class="secondary" id="customLogoutCancel">å–æ¶ˆ</button>
            <button type="button" class="primary" id="customLogoutSave">å„²å­˜</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="appToast" class="toast" role="button" tabindex="0" aria-live="polite"></div>

  <nav class="navbar">
    <button id="nav-contacts" class="navbtn" aria-label="è¯çµ¡äºº">
      <span class="nav-badge" data-tab="contacts"></span>
      <i class='bx bx-user-circle' style="font-size:22px"></i>
      <span>è¯çµ¡äºº</span>
    </button>
    <button id="nav-messages" class="navbtn" aria-label="è¨Šæ¯">
      <span class="nav-badge" data-tab="messages"></span>
      <i class='bx bx-message-dots' style="font-size:22px"></i>
      <span>è¨Šæ¯</span>
    </button>
    <button id="nav-drive" class="navbtn active" aria-label="åŠ å¯†é›²ç«¯">
      <span class="nav-badge" data-tab="drive"></span>
      <span class="nav-icon-stack" aria-hidden="true">
        <i class='bx bxs-cloud nav-icon-base'></i>
        <i class='bx bx-lock-alt nav-icon-lock'></i>
      </span>
      <span>åŠ å¯†é›²ç«¯</span>
    </button>
    <button id="nav-profile" class="navbtn" aria-label="æˆ‘çš„æª”æ¡ˆ">
      <span class="nav-badge" data-tab="profile"></span>
      <i class='bx bx-user' style="font-size:22px"></i>
      <span>æˆ‘çš„æª”æ¡ˆ</span>
    </button>
  </nav>

  <div id="mediaPermissionOverlay" class="media-permission-overlay" aria-hidden="true" style="display:none">
    <div class="media-permission-card" role="dialog" aria-modal="true" aria-labelledby="mediaPermissionTitle">
      <i class='bx bxs-lock-shield icon' aria-hidden="true"></i>
      <h2 id="mediaPermissionTitle">å•Ÿç”¨èªéŸ³é€šè©±</h2>
      <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œä¸€éµæˆæ¬Šéº¥å…‹é¢¨ä¸¦è§£é–éŸ³è¨Šæ’­æ”¾ï¼Œç¢ºä¿ä¾†é›»æ­£å¸¸éŸ¿éˆ´ã€‚</p>
      <ul>
        <li><i class='bx bx-microphone'></i><span>å…è¨±éº¥å…‹é¢¨æ‰èƒ½å»ºç«‹ç«¯åˆ°ç«¯åŠ å¯†èªéŸ³é€šè©±ã€‚</span></li>
        <li><i class='bx bx-volume-full'></i><span>åŒæ™‚è§£é–éŸ³è¨Šæ’­æ”¾ï¼Œé¿å…ä¾†é›»éˆ´è²è¢«ç€è¦½å™¨é˜»æ“‹ã€‚</span></li>
      </ul>
      <div id="mediaPermissionStatus" class="media-permission-status" role="status" aria-live="polite"></div>
      <p class="media-permission-hints">
        è‹¥æœªå½ˆå‡ºç€è¦½å™¨æˆæ¬Šè¦–çª—ï¼Œè«‹æŒ‰ã€Œå–æ¶ˆé‡è©¦ã€å¾Œå†è©¦ä¸€æ¬¡ï¼Œæˆ–ç¨å¾Œåˆ° Safari è¨­å®š > ç¶²ç«™é€²éšè¨­å®š > éº¥å…‹é¢¨é‡æ–°å…è¨±ã€‚
      </p>
      <div class="media-permission-actions">
        <button id="mediaPermissionAllowBtn" type="button" class="media-permission-btn">
          <i class='bx bx-check-shield'></i><span id="mediaPermissionAllowLabel">å…è¨±éº¥å…‹é¢¨</span>
        </button>
        <button id="mediaPermissionDebugBtn" type="button" class="media-permission-skip" style="display:none">æŸ¥è©¢
          Debug</button>
        <button id="mediaPermissionSkipBtn" type="button" class="media-permission-skip">ç¨å¾Œå†èªª</button>
      </div>
    </div>
  </div>

  <div id="logoutRedirectCover" class="logout-redirect-cover" aria-hidden="true">
    <div class="cover-spinner" aria-hidden="true"></div>
  </div>
  <script>
    window.API_ORIGIN = 'https://api.message.sentry.red';
    (function () {
      const overlay = document.getElementById('orientationOverlay');
      const docEl = document.documentElement;
      const mq = window.matchMedia('(orientation: portrait)');
      const isMobileLike = () => {
        const touch = navigator.maxTouchPoints || navigator.msMaxTouchPoints || 0;
        const shortEdge = Math.min(window.innerWidth, window.innerHeight);
        const ua = navigator.userAgent || '';
        const looksMobileUA = /iPhone|iPad|Android|Mobile/i.test(ua);
        return shortEdge <= 1024 && (touch > 0 || looksMobileUA);
      };
      function update() {
        if (!isMobileLike()) {
          docEl.classList.remove('orientation-block');
          if (overlay) overlay.setAttribute('aria-hidden', 'true');
          return;
        }
        const portrait = mq.matches || window.innerHeight >= window.innerWidth;
        if (portrait) {
          docEl.classList.remove('orientation-block');
          if (overlay) overlay.setAttribute('aria-hidden', 'true');
        } else {
          docEl.classList.add('orientation-block');
          if (overlay) overlay.setAttribute('aria-hidden', 'false');
        }
      }
      if (mq.addEventListener) mq.addEventListener('change', update); else mq.addListener(update);
      window.addEventListener('orientationchange', update);
      window.addEventListener('resize', update);
      update();
      if (screen.orientation && screen.orientation.lock && isMobileLike()) {
        screen.orientation.lock('portrait').catch(() => { });
      }
    })();
    (function disablePinchZoom() {
      const prevent = (evt) => evt.preventDefault();
      document.addEventListener('gesturestart', prevent, { passive: false });
      document.addEventListener('gesturechange', prevent, { passive: false });
      document.addEventListener('gestureend', prevent, { passive: false });
    })();
    (function maintainAppHeight() {
      const docEl = document.documentElement;
      let baseHeight = window.innerHeight || docEl.clientHeight || 0;
      const applyHeight = (value) => {
        if (!value) return;
        docEl.style.setProperty('--app-height', `${value}px`);
      };
      applyHeight(baseHeight);
      window.addEventListener('resize', () => {
        const current = window.innerHeight || docEl.clientHeight || 0;
        if (!current) return;
        if (current >= baseHeight - 2) {
          baseHeight = current;
          applyHeight(baseHeight);
        }
      });
      window.addEventListener('orientationchange', () => {
        setTimeout(() => {
          const current = window.innerHeight || docEl.clientHeight || baseHeight;
          baseHeight = current;
          applyHeight(baseHeight);
        }, 300);
      });
    })();
  </script>
  <script>
    (function loadAppModule() {
      const stamp = window.APP_BUILD_AT || window.APP_VERSION || String(Date.now());
      const versionedSrc = `/app/ui/app-mobile.js?v=${encodeURIComponent(stamp)}`;
      const script = document.createElement('script');
      script.type = 'module';
      script.src = versionedSrc;
      script.onerror = () => {
        if (script.dataset.retry) return;
        script.dataset.retry = '1';
        const fallback = document.createElement('script');
        fallback.type = 'module';
        fallback.src = `/app/ui/app-mobile.js?v=${Date.now()}`;
        document.body.appendChild(fallback);
      };
      document.body.appendChild(script);
    })();
  </script>
</body>

</html>
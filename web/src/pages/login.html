

<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <meta name="color-scheme" content="light" />
    <title>SENTRY MESSENGER â€” Login</title>
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon" />
    <script>
      // e2e: query ?e2e=1 ä»¥åœç”¨å‹•ç•«
      try {
        const params = new URLSearchParams(location.search);
        if (params.get('e2e') === '1') {
          document.documentElement.classList.add('no-anim');
        }
      } catch {}
      window.APP_VERSION = '0.1.10';
      window.APP_BUILD_AT = (function(){ try { return new Date(document.lastModified).toISOString(); } catch { return new Date().toISOString(); } })();
    </script>
    <style>
      #loginSplash{position:fixed;inset:0;z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(160deg,#0f172a,#1e293b 65%,#020617);transition:opacity .35s ease}
      #loginSplash.fade-out{opacity:0;pointer-events:none}
      #loginSplash .splash-logo{width:48px;height:48px;margin-bottom:14px}
      #loginSplash .splash-brand{font-size:15px;font-weight:700;letter-spacing:2.2px;color:#f8fafc;margin-bottom:22px}
      #loginSplash .splash-spinner{width:36px;height:36px;border-radius:50%;border:3px solid rgba(148,163,184,0.25);border-top-color:#38bdf8;animation:login-spin .9s linear infinite;margin-bottom:12px}
      #loginSplash .splash-text{font-size:13px;color:#94a3b8;letter-spacing:.3px}
      html.no-anim #loginSplash .splash-spinner{animation:none}
      :root { color-scheme: light; --bg:#0f172a; --fg:#111827; --muted:#64748b; --line:#e2e8f0; --card:#ffffff; --gradient: linear-gradient(160deg,#0f172a,#1e293b 65%,#020617); }
      html, body { height:100%; min-height:100%; }
      html { background:var(--gradient); }
      /* æ¸›å°‘åˆå§‹å‹•ç•«å¹²æ“¾ï¼ˆe2e ç”¨ï¼‰ï¼šåœç”¨æ—‹è½‰ï¼ˆåƒ…ç•¶ html.no-animï¼‰ */
      html.no-anim .loading-spinner,
      html.no-anim button.loading .btn-spinner,
      html.no-anim .spinner,
      html.no-anim .icon.spin {
        animation: none !important;
      }
      * { box-sizing:border-box; }
      body {
        margin:0;
        min-height:100vh;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, 'Noto Sans TC', sans-serif;
        background:var(--gradient);
        background-attachment:fixed;
        display:flex;
        justify-content:center;
        align-items:center;
        padding:calc(32px + env(safe-area-inset-top, 0px)) 18px calc(32px + env(safe-area-inset-bottom, 0px));
        overscroll-behavior:contain;
        position:relative;
      }
      body::before {
        content:'';
        position:fixed;
        left:0;
        right:0;
        top:-120vh;
        bottom:-120vh;
        background:var(--gradient);
        z-index:-1;
        pointer-events:none;
      }
      .login-shell {
        width:min(420px,100%);
        background:var(--card);
        border-radius:24px;
        padding:32px 26px 36px;
        box-shadow:0 26px 60px rgba(15,23,42,0.45);
        position:relative;
      }
      .brand { position:relative; display:flex; align-items:center; gap:12px; margin-bottom:18px; }
      .brand img { height:30px; width:auto; }
      .brand h1 { margin:0; font-size:22px; font-weight:700; letter-spacing:0.4px; color:var(--fg); }
      .subtitle { margin:0 0 24px; color:var(--muted); font-size:13px; line-height:1.5; }
      form { display:flex; flex-direction:column; gap:16px; }
      .form-group { display:flex; flex-direction:column; gap:6px; }
      .form-group.hidden { display:none; }
      .hidden { display:none !important; }
      .form-group label { font-size:13px; color:var(--muted); }
      .input {
        width:100%;
        border:1px solid var(--line);
        border-radius:14px;
        padding:12px 14px;
        font-size:15px;
        background:#f8fafc;
        transition:border-color .2s, box-shadow .2s;
      }
      .input.display {
        background:#eef2ff;
        border-style:dashed;
        color:#1e293b;
        min-height:48px;
        display:flex;
        align-items:center;
      }
      .input:focus {
        outline:none;
        border-color:#6366f1;
        box-shadow:0 0 0 3px rgba(99,102,241,0.18);
        background:#fff;
      }
      .uid-card {
        display:flex;
        align-items:center;
        justify-content:center;
        flex-direction:column;
        gap:12px;
        padding:8px 0 12px;
        margin:6px 0 0;
        transition:transform .3s ease;
      }
      .uid-identicon {
        width:72px;
        height:72px;
        border-radius:18px;
        background:radial-gradient(circle at 30% 30%, #e0f2fe, #c084fc);
        border:2px solid rgba(15,23,42,0.22);
        box-shadow:0 12px 30px rgba(0,0,0,0.16), 0 5px 12px rgba(0,0,0,0.12);
        position:relative;
        overflow:hidden;
        flex-shrink:0;
      }
      .uid-identicon.pending { animation: none; }
      .uid-identicon.pending .mosaic {
        width:100%;
        height:100%;
        display:grid;
        grid-template-columns:repeat(5,1fr);
        grid-template-rows:repeat(5,1fr);
        gap:0;
        padding:0;
        box-sizing:border-box;
      }
      .uid-identicon.pending .mosaic div {
        border-radius:0;
        background: #dbeafe;
      }
      .uid-identicon svg { width:100%; height:100%; display:block; }
      .login-shell.login-verified .uid-card {
        transform:translateY(-10px);
      }
      .password-area {
        max-height:0;
        opacity:0;
        transform:translateY(10px);
        overflow:hidden;
        pointer-events:none;
        transition:max-height .3s ease, opacity .3s ease, transform .3s ease;
        margin:0;
      }
      .login-shell.login-verified .password-area {
        max-height:520px;
        opacity:1;
        transform:translateY(0);
        pointer-events:auto;
        margin-top:8px;
      }
      .grid-two { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; }
      button {
        border:none;
        border-radius:16px;
        padding:12px 16px;
        font-size:15px;
        font-weight:600;
        cursor:pointer;
        transition:transform .15s ease, box-shadow .15s ease;
      }
      button.primary {
        background:linear-gradient(135deg,#0f172a,#1e293b);
        color:#fff;
        box-shadow:0 14px 32px rgba(15,23,42,0.35);
      }
      button.secondary { background:#f1f5f9; color:#0f172a; }
      button:disabled { opacity:0.55; cursor:not-allowed; box-shadow:none; }
      button:active { transform:translateY(1px); }
      .actions { display:flex; flex-direction:column; gap:10px; margin-top:4px; }
      .password-field { position:relative; display:flex; align-items:center; }
      .password-field .input { padding-right:42px; }
      .password-toggle {
        position:absolute;
        right:10px;
        top:50%;
        transform:translateY(-50%);
        border:none;
        background:transparent;
        color:#475569;
        font-size:18px;
        cursor:pointer;
        padding:4px;
      }
      .password-toggle .pw-icon { width:20px; height:20px; }
      .password-toggle:focus { outline:none; }
      .notice {
        display:flex;
        align-items:flex-start;
        gap:10px;
        font-size:12px;
        color:#0f172a;
        line-height:1.6;
        background:rgba(56,189,248,0.12);
        border:1px solid rgba(56,189,248,0.6);
        border-radius:16px;
        padding:12px 14px;
      }
      .notice-icon {
        display:inline-flex;
        align-items:center;
        justify-content:center;
        background:rgba(56,189,248,0.2);
        color:#0284c7;
        border-radius:999px;
        width:28px;
        height:28px;
        font-size:15px;
        flex-shrink:0;
      }
      .notice-text {
        margin:0;
        color:#0f172a;
      }
      .modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:50; padding:16px; box-sizing:border-box; }
      .modal-backdrop { position:absolute; inset:0; background:rgba(15,23,42,0.55); backdrop-filter:blur(4px); }
      .modal-panel { position:relative; z-index:1; width:min(360px,90vw); background:#0f172a; color:#f8fafc; border-radius:20px; padding:22px 20px; box-shadow:0 24px 60px rgba(2,6,23,0.55); display:flex; flex-direction:column; gap:12px; max-height:calc(100vh - 32px); overflow-y:auto; box-sizing:border-box; }
      .modal-head { display:flex; justify-content:space-between; align-items:center; font-weight:600; font-size:15px; }
      .modal-body { font-size:13px; line-height:1.6; white-space:pre-wrap; word-break:break-word; }
      .modal-close { border:none; background:rgba(248,250,252,0.12); color:#f8fafc; border-radius:999px; width:30px; height:30px; cursor:pointer; }
      .modal-close:active { transform:translateY(1px); }
      .welcome-modal .modal-panel { background:#0b1220; }
      .welcome-modal h2 { margin:0 0 8px; font-size:18px; letter-spacing:0.4px; }
      .welcome-modal ul { margin:0; padding-left:18px; display:flex; flex-direction:column; gap:8px; font-size:13px; line-height:1.6; }
      .welcome-modal .modal-body { max-height:min(55vh, 320px); overflow-y:auto; user-select:none; -webkit-user-select:none; padding-right:4px; }
      .welcome-actions { display:flex; justify-content:flex-end; }
      .welcome-actions button { border-radius:12px; padding:8px 16px; background:#38bdf8; color:#0f172a; font-weight:600; border:none; cursor:pointer; }
      .welcome-actions button:active { transform:translateY(1px); }
      .dev-hidden { display:none !important; }
      .loading-backdrop { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(15,23,42,0.85); backdrop-filter:blur(3px); z-index:100; }
      .loading-card { display:flex; flex-direction:column; align-items:center; gap:14px; padding:26px 30px; border-radius:20px; background:#0b1220; color:#f8fafc; box-shadow:0 22px 48px rgba(2,6,23,0.45); min-width:220px; max-width:320px; }
      .loading-spinner { width:48px; height:48px; border-radius:50%; border:4px solid rgba(148,163,184,0.25); border-top-color:#38bdf8; animation:login-spin .9s linear infinite; }
      .loading-text { font-size:14px; line-height:1.6; text-align:center; letter-spacing:0.5px; }
      .bootstrap-progress { width:100%; margin-top:8px; padding-top:12px; border-top:1px solid rgba(148,163,184,0.3); display:flex; flex-direction:column; gap:8px; max-height:240px; overflow:hidden; }
      .bootstrap-progress.hidden { display:none !important; }
      .bootstrap-progress .progress-note { font-size:12px; color:rgba(226,232,240,0.85); text-align:left; flex-shrink:0; }
      .bootstrap-progress ul { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:6px; max-height:176px; overflow-y:auto; padding-right:4px; }
      .bootstrap-progress ul::-webkit-scrollbar { width:6px; }
      .bootstrap-progress ul::-webkit-scrollbar-thumb { background:rgba(148,163,184,0.5); border-radius:999px; }
      .bootstrap-progress ul::-webkit-scrollbar-track { background:rgba(15,23,42,0.2); }
      .bootstrap-progress li { display:flex; flex-direction:column; gap:2px; padding:8px 10px; border-radius:12px; background:rgba(15,23,42,0.35); border:1px solid rgba(148,163,184,0.35); color:#e2e8f0; font-size:12px; transition:background 0.2s ease, border-color 0.2s ease, opacity 0.32s ease, transform 0.32s ease, max-height 0.32s ease, margin 0.32s ease, padding 0.32s ease, border-width 0.32s ease; max-height:200px; will-change:opacity, transform; }
      .bootstrap-progress li .row { display:flex; align-items:center; justify-content:space-between; gap:10px; }
      .bootstrap-progress li .label-text { font-weight:600; letter-spacing:0.2px; }
      .bootstrap-progress li .status-text { font-weight:600; font-size:11px; text-transform:uppercase; letter-spacing:0.4px; }
      .bootstrap-progress li .detail-text { font-size:11px; color:rgba(226,232,240,0.78); }
      .bootstrap-progress li.in-progress { border-color:rgba(96,165,250,0.65); background:rgba(37,99,235,0.28); }
      .bootstrap-progress li.success { border-color:rgba(52,211,153,0.7); background:rgba(16,185,129,0.28); }
      .bootstrap-progress li.error { border-color:rgba(248,113,113,0.75); background:rgba(248,113,113,0.22); }
      .bootstrap-progress li.skip { opacity:0.65; }
      .bootstrap-progress li.info { border-color:rgba(96,165,250,0.55); background:rgba(59,130,246,0.22); }
      .bootstrap-progress li.fading-out { opacity:0; max-height:0; margin:0; padding:0; border-width:0; transform:translateY(-6px); overflow:hidden; }
      @keyframes login-spin { to { transform:rotate(360deg); } }
      .orientation-overlay { position:fixed; inset:0; background:linear-gradient(160deg,rgba(15,23,42,0.98),rgba(15,23,42,0.92)); color:#f8fafc; display:none; align-items:center; justify-content:center; flex-direction:column; gap:12px; text-align:center; padding:32px; z-index:2000; font-size:18px; line-height:1.6; letter-spacing:0.4px; }
      .orientation-overlay .icon { font-size:42px; display:block; }
      html.orientation-block { height:100%; overflow:hidden; }
      html.orientation-block body { overflow:hidden; height:100%; }
      html.orientation-block .orientation-overlay { display:flex; }
      button, input, select, textarea { font-family:inherit; color:inherit; font-size:14px; }
      .version-info-btn { position:fixed; bottom:16px; right:16px; width:28px; height:28px; border-radius:999px; border:none; background:rgba(15,23,42,0.78); color:#f8fafc; font-size:14px; font-weight:600; display:flex; align-items:center; justify-content:center; cursor:pointer; opacity:0.55; transition:opacity .2s ease, transform .2s ease; z-index:2200; }
      .version-info-btn:hover, .version-info-btn:focus-visible { opacity:0.95; transform:scale(1.05); outline:none; }
      .version-info-popup { position:fixed; bottom:54px; right:16px; max-width:240px; border-radius:14px; padding:12px 14px; font-size:12px; line-height:1.6; background:rgba(15,23,42,0.92); color:#f1f5f9; box-shadow:0 14px 34px rgba(15,23,42,0.45); z-index:2200; display:none; }
      .version-info-popup[data-open="true"] { display:block; }
      .version-info-popup strong { display:block; font-size:12px; letter-spacing:0.3px; margin-bottom:4px; color:#bae6fd; }
      .version-storage-list { display:flex; flex-direction:column; gap:6px; margin-top:6px; }
      .version-storage-row { width:100%; display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 10px; border-radius:10px; border:1px solid rgba(148,163,184,0.35); background:rgba(15,23,42,0.9); color:#e2e8f0; text-align:left; font-size:12px; box-shadow:0 10px 26px rgba(2,6,23,0.32); }
      .version-storage-row span:last-child { color:#bae6fd; }
      .version-storage-total { padding:8px 10px; border-radius:10px; border:1px solid rgba(148,163,184,0.35); background:rgba(15,23,42,0.78); color:#bfdbfe; }
      #loginTransitionModal{position:fixed;inset:0;z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#050a14;font-family:'SF Mono',SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace;transition:opacity .5s ease;overflow:hidden}
      #loginTransitionModal.hidden{display:none}
      #loginTransitionModal .tm-canvas{position:absolute;inset:0;z-index:0}
      #loginTransitionModal .tm-overlay{position:absolute;inset:0;z-index:1;background:radial-gradient(ellipse at 50% 50%,transparent 0%,rgba(5,10,20,0.4) 60%,rgba(5,10,20,0.85) 100%);pointer-events:none}
      #loginTransitionModal .tm-content{position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;gap:0;pointer-events:none}
      #loginTransitionModal .tm-logo{width:52px;height:52px;margin-bottom:18px;filter:drop-shadow(0 0 18px rgba(56,189,248,0.45)) drop-shadow(0 0 40px rgba(99,102,241,0.25));animation:tm-pulse 3s ease-in-out infinite}
      #loginTransitionModal .tm-brand{font-size:18px;font-weight:700;letter-spacing:4px;color:#e0f2fe;margin-bottom:8px;text-shadow:0 0 20px rgba(56,189,248,0.5),0 0 40px rgba(99,102,241,0.3);min-width:220px;text-align:center;height:1.4em;line-height:1.4em}
      #loginTransitionModal .tm-brand .char{display:inline-block;transition:color .15s ease,text-shadow .15s ease}
      #loginTransitionModal .tm-brand .char.resolved{color:#e0f2fe}
      #loginTransitionModal .tm-brand .char.scrambling{color:#38bdf8;text-shadow:0 0 8px rgba(56,189,248,0.8)}
      #loginTransitionModal .tm-sublabel{font-size:11px;letter-spacing:2.5px;color:rgba(148,163,184,0.65);text-transform:uppercase;margin-bottom:32px}
      #loginTransitionModal .tm-bar-track{width:200px;height:2px;border-radius:1px;background:rgba(148,163,184,0.15);overflow:hidden;position:relative;margin-bottom:16px}
      #loginTransitionModal .tm-bar-fill{width:0%;height:100%;border-radius:1px;background:linear-gradient(90deg,#0ea5e9,#6366f1,#a855f7);box-shadow:0 0 12px rgba(99,102,241,0.6);transition:width .3s ease}
      #loginTransitionModal .tm-bar-scan{position:absolute;top:0;height:100%;width:40px;background:linear-gradient(90deg,transparent,rgba(56,189,248,0.6),transparent);animation:tm-scan 2s linear infinite}
      #loginTransitionModal .loading-label{font-size:12px;color:rgba(148,163,184,0.7);letter-spacing:1px}
      @keyframes tm-pulse{0%,100%{filter:drop-shadow(0 0 18px rgba(56,189,248,0.45)) drop-shadow(0 0 40px rgba(99,102,241,0.25))}50%{filter:drop-shadow(0 0 28px rgba(56,189,248,0.7)) drop-shadow(0 0 60px rgba(99,102,241,0.4))}}
      @keyframes tm-scan{0%{left:-40px}100%{left:calc(100% + 40px)}}
      html.no-anim #loginTransitionModal .tm-logo{animation:none}
      html.no-anim #loginTransitionModal .tm-bar-scan{animation:none}
    </style>
  </head>
  <body>
    <div id="loginSplash">
      <img class="splash-logo" src="/assets/images/logo.svg" alt="" />
      <div class="splash-brand">SENTRY MESSENGER</div>
      <div class="splash-spinner" aria-hidden="true"></div>
      <div class="splash-text">è¼‰å…¥ä¸­â€¦</div>
    </div>
    <script>
      window.__hideLoginSplash = function(){
        var el = document.getElementById('loginSplash');
        if (!el) return;
        el.classList.add('fade-out');
        setTimeout(function(){ if (el.parentNode) el.parentNode.removeChild(el); }, 400);
      };
      setTimeout(function(){ window.__hideLoginSplash(); }, 8000);
    </script>
    <div id="orientationOverlay" class="orientation-overlay" aria-hidden="true">
      <span class="icon" aria-hidden="true">ğŸ“±</span>
      <strong>è«‹ä»¥ç›´ç«‹æ¨¡å¼ä½¿ç”¨</strong>
      <span>ç‚ºç¶­æŒæœ€ä½³ä½¿ç”¨é«”é©—ï¼Œè«‹å°‡è£ç½®æ—‹è½‰å›ç›´ç«‹æ–¹å‘ã€‚</span>
    </div>
    <main class="login-shell">
      <div class="brand" id="loginBrand">
        <img src="/assets/images/logo.svg" alt="SENTRY MESSENGER" />
        <h1>SENTRY MESSENGER</h1>
      </div>
      <p class="subtitle">æ„Ÿæ‡‰ SENTRY MESSENGER æ™¶ç‰‡å¾Œè¼¸å…¥å¯†ç¢¼å³å¯ç™»å…¥ã€‚</p>

      <form autocomplete="off" data-1p-ignore="true" data-lpignore="true">
        <div class="uid-card" id="uidCard" aria-label="æ™¶ç‰‡è­˜åˆ¥åœ–">
          <div class="uid-identicon pending" id="uidIdenticon" aria-hidden="true">
            <div class="mosaic">
              <div style="--i:0"></div><div style="--i:1"></div><div style="--i:2"></div><div style="--i:3"></div><div style="--i:4"></div>
              <div style="--i:5"></div><div style="--i:6"></div><div style="--i:7"></div><div style="--i:8"></div><div style="--i:9"></div>
              <div style="--i:10"></div><div style="--i:11"></div><div style="--i:12"></div><div style="--i:13"></div><div style="--i:14"></div>
              <div style="--i:15"></div><div style="--i:16"></div><div style="--i:17"></div><div style="--i:18"></div><div style="--i:19"></div>
              <div style="--i:20"></div><div style="--i:21"></div><div style="--i:22"></div><div style="--i:23"></div><div style="--i:24"></div>
            </div>
          </div>
          <!-- UID åƒ…ä¾› SDM é©—è­‰é¡¯ç¤ºï¼Œä¸åƒèˆ‡äº¤æ£’æˆ–æäº¤ -->
        </div>

        <div class="grid-two">
          <div class="form-group hidden" id="macWrapper">
            <label for="sdmMac">NTAG MACï¼ˆ16 hexï¼‰</label>
            <input id="sdmMac" class="input" type="text" placeholder="501EC4EF6E38555E" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" />
          </div>
          <div class="form-group hidden" id="ctrWrapper">
            <label for="sdmCtr">Counter</label>
            <input id="sdmCtr" class="input" type="text" placeholder="50 æˆ– 000050" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" />
          </div>
        </div>

        <div class="form-group hidden" id="nonceWrapper">
          <label for="nonce">Nonceï¼ˆé¸å¡«ï¼‰</label>
          <input id="nonce" class="input" type="text" placeholder="optional" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" />
        </div>

        <button id="btnSdmExchange" type="button" class="primary hidden" style="width:100%">é©—è­‰ NTAGï¼ˆSDM Exchangeï¼‰</button>

        <div class="form-group hidden" id="sessionWrapper">
          <label for="sessionView">ä¸€æ¬¡æ€§ Session</label>
          <input id="sessionView" class="input" type="text" readonly placeholder="é©—è­‰å¾Œè‡ªå‹•å¸¶å…¥" />
        </div>

        <div class="password-area" id="passwordArea">
          <div class="form-group" id="passwordWrapper">
            <label for="pwd">ç™»å…¥å¯†ç¢¼</label>
            <div class="password-field">
              <input id="pwd" class="input" type="password" placeholder="è‡³å°‘å…­ä½æ•¸" autocomplete="new-password" autocapitalize="off" autocorrect="off" spellcheck="false" data-1p-ignore="true" data-lpignore="true" name="__no_store_pwd__" />
              <button type="button" class="password-toggle" data-target="pwd" aria-label="é¡¯ç¤ºå¯†ç¢¼" tabindex="-1"><svg class="pw-icon" data-state="show" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 9a3.02 3.02 0 0 0-3 3c0 1.642 1.358 3 3 3 1.641 0 3-1.358 3-3 0-1.641-1.359-3-3-3z"/><path d="M12 5c-7.633 0-9.927 6.617-9.948 6.684L1.946 12l.105.316C2.073 12.383 4.367 19 12 19s9.927-6.617 9.948-6.684l.106-.316-.105-.316C21.927 11.617 19.633 5 12 5zm0 12c-5.351 0-7.424-3.846-7.926-5C4.578 10.842 6.652 7 12 7c5.351 0 7.424 3.846 7.926 5-.504 1.158-2.578 5-7.926 5z"/></svg></button>
            </div>
          </div>

          <div class="form-group hidden" id="confirmWrapper">
            <label for="pwdConfirm">ç¢ºèªå¯†ç¢¼</label>
            <div class="password-field">
              <input id="pwdConfirm" class="input" type="password" placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼" autocomplete="new-password" autocapitalize="off" autocorrect="off" spellcheck="false" />
              <button type="button" class="password-toggle" data-target="pwdConfirm" aria-label="é¡¯ç¤ºå¯†ç¢¼" tabindex="-1"><svg class="pw-icon" data-state="show" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 9a3.02 3.02 0 0 0-3 3c0 1.642 1.358 3 3 3 1.641 0 3-1.358 3-3 0-1.641-1.359-3-3-3z"/><path d="M12 5c-7.633 0-9.927 6.617-9.948 6.684L1.946 12l.105.316C2.073 12.383 4.367 19 12 19s9.927-6.617 9.948-6.684l.106-.316-.105-.316C21.927 11.617 19.633 5 12 5zm0 12c-5.351 0-7.424-3.846-7.926-5C4.578 10.842 6.652 7 12 7c5.351 0 7.424 3.846 7.926 5-.504 1.158-2.578 5-7.926 5z"/></svg></button>
            </div>
          </div>
        </div>

      <div class="actions">
        <button id="btnUnlock" type="button" class="primary" disabled>ç™»å…¥</button>
      </div>

      <p class="notice"><span class="notice-icon" aria-hidden="true">ğŸ”’</span><span class="notice-text">SENTRY MESSENGER æ¡ç”¨ E2EE ç«¯å°ç«¯åŠ å¯†æŠ€è¡“ï¼Œæ‰€æœ‰åŠ è§£å¯†å‡æ–¼å‰ç«¯è¨ˆç®—ï¼Œä¼ºæœå™¨ç«¯åƒ…å„²å­˜åŠ å¯†éçš„è³‡è¨Šï¼Œæ‰€æœ‰æ•æ„Ÿè³‡è¨Šåƒ…ä¿ç•™æ–¼è¨˜æ†¶é«”ï¼Œä¸¦æ–¼ç•«é¢åˆ‡æ›æ™‚å³åˆ»æ¸…é™¤ã€‚</span></p>
    </form>
    <div id="loginModal" class="modal hidden" aria-hidden="true">
      <div class="modal-backdrop" id="loginModalBackdrop"></div>
      <div class="modal-panel" role="dialog" aria-modal="true">
        <div class="modal-head">
          <span>ç³»çµ±è¨Šæ¯</span>
          <button id="loginModalClose" class="modal-close" type="button">Ã—</button>
        </div>
        <div id="loginModalBody" class="modal-body"></div>
      </div>
    </div>
    <div id="welcomeModal" class="modal welcome-modal hidden" aria-hidden="true">
      <div class="modal-backdrop"></div>
      <div class="modal-panel" role="dialog" aria-modal="true">
        <div class="modal-head">
          <h2>è¿æ¥å¶„æ–°çš„éš±ç§é€šè¨Šï¼</h2>
          <button type="button" class="modal-close" id="welcomeClose">Ã—</button>
        </div>
        <div id="welcomeContent" class="modal-body">
          <ul>
            <li>é›¶æ­»è§’æ¡ç”¨æœ€å…ˆé€²çš„ E2EE ç«¯å°ç«¯åŠ å¯†æŠ€è¡“ã€‚</li>
            <li>æˆ‘å€‘ç„¡æ³•å¾—çŸ¥ä½ è·Ÿèª°èŠå¤©ã€èŠäº†ä»€éº¼ã€‚</li>
            <li>æˆ‘å€‘ç„¡æ³•ç²å–ä½ çš„æš±ç¨±ã€é ­åƒã€ç”šè‡³å¥½å‹è³‡è¨Šã€‚</li>
            <li>æ¥­ç•Œé¦–å‰µæä¾›å…ˆé€²åŠ å¯†æŠ€è¡“é›²ç«¯ç©ºé–“ï¼Œä¸åªä¿è­·å°è©±ï¼Œè³‡æ–™ä¹Ÿä¸€ä½µä¿éšœã€‚</li>
            <li>å¼•å…¥æ™¶ç‰‡å³èº«åˆ†æ¦‚å¿µï¼Œä»»ä½•äººç„¡æ³•é€éæ‰‹æ©Ÿè™Ÿç¢¼æˆ– E-mail è¿½è¹¤ä½ çš„èº«åˆ†ã€‚</li>
          </ul>
        </div>
        <div class="welcome-actions">
          <button type="button" id="welcomeNext">é–‹å§‹è¨­å®šå¯†ç¢¼</button>
        </div>
      </div>
    </div>
  </main>

    <div id="loginLoading" class="loading-backdrop hidden" role="presentation">
      <div class="loading-card" role="status" aria-live="polite">
        <div class="loading-spinner" aria-hidden="true"></div>
        <div id="loginLoadingText" class="loading-text">ç™»å…¥ä¸­ï¼Œè«‹ç¨å€™â€¦</div>
        <div id="loginBootstrapProgress" class="bootstrap-progress hidden">
          <div class="progress-note">é¦–æ¬¡ç™»å…¥éœ€è¦åˆå§‹åŒ–ä¸‹åˆ—é …ç›®ï¼š</div>
          <ul id="loginBootstrapSteps"></ul>
        </div>
      </div>
    </div>

    <section class="dev-hidden">
      <button id="btnHealth" type="button" aria-hidden="true"></button>
      <button id="btnClear" type="button" aria-hidden="true"></button>
      <pre id="out" aria-hidden="true"></pre>
      <button id="btnDevClearLocal" type="button" aria-hidden="true"></button>
    </section>

    <button class="version-info-btn" id="versionInfoBtnLogin" aria-label="é¡¯ç¤ºç‰ˆæœ¬è³‡è¨Š">i</button>
    <div class="version-info-popup" id="versionInfoPopupLogin" role="dialog" aria-hidden="true"></div>

    <!-- Transition modal â€” sci-fi particle + matrix rain + text decrypt -->
    <div id="loginTransitionModal" class="hidden">
      <canvas class="tm-canvas" id="tmCanvas"></canvas>
      <div class="tm-overlay"></div>
      <div class="tm-content">
        <img class="tm-logo" src="/assets/images/logo.svg" alt="" />
        <div class="tm-brand" id="tmBrand" aria-label="SENTRY MESSENGER"></div>
        <div class="tm-sublabel">END-TO-END ENCRYPTED</div>
        <div class="tm-bar-track">
          <div id="loginTransitionBar" class="tm-bar-fill"></div>
          <div class="tm-bar-scan"></div>
        </div>
        <div id="loginTransitionLabel" class="loading-label">INITIALIZING...</div>
      </div>
    </div>
    <script>
    /* â”€â”€ Transition Canvas: Particle Constellation + Matrix Rain â”€â”€ */
    (function(){
      var cvs, ctx, w, h, raf, particles, columns, drops, running = false;
      var PARTICLE_COUNT = 65;
      var MATRIX_CHARS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½$@#&%!?<>{}[]';
      var FONT_SIZE = 13;
      var PARTICLE_SPEED = 0.3;
      var LINE_DIST = 120;

      function initCanvas(){
        cvs = document.getElementById('tmCanvas');
        if(!cvs) return;
        ctx = cvs.getContext('2d');
        resize();
        window.addEventListener('resize', resize);
      }

      function resize(){
        if(!cvs) return;
        w = cvs.width = cvs.parentElement.clientWidth;
        h = cvs.height = cvs.parentElement.clientHeight;
        initParticles();
        initMatrix();
      }

      function initParticles(){
        particles = [];
        for(var i=0;i<PARTICLE_COUNT;i++){
          particles.push({
            x: Math.random()*w,
            y: Math.random()*h,
            vx: (Math.random()-0.5)*PARTICLE_SPEED,
            vy: (Math.random()-0.5)*PARTICLE_SPEED,
            r: Math.random()*1.5+0.5,
            a: Math.random()*0.5+0.3
          });
        }
      }

      function initMatrix(){
        columns = Math.floor(w / FONT_SIZE);
        drops = [];
        for(var i=0;i<columns;i++){
          drops[i] = -(Math.random()*80|0); // stagger start
        }
      }

      function drawParticles(){
        for(var i=0;i<particles.length;i++){
          var p = particles[i];
          p.x += p.vx; p.y += p.vy;
          if(p.x<0) p.x=w; if(p.x>w) p.x=0;
          if(p.y<0) p.y=h; if(p.y>h) p.y=0;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
          ctx.fillStyle = 'rgba(56,189,248,' + p.a + ')';
          ctx.fill();
        }
        // Draw connection lines
        ctx.lineWidth = 0.4;
        for(var i=0;i<particles.length;i++){
          for(var j=i+1;j<particles.length;j++){
            var dx=particles[i].x-particles[j].x;
            var dy=particles[i].y-particles[j].y;
            var dist=dx*dx+dy*dy;
            if(dist<LINE_DIST*LINE_DIST){
              var alpha = (1 - Math.sqrt(dist)/LINE_DIST) * 0.25;
              ctx.beginPath();
              ctx.moveTo(particles[i].x, particles[i].y);
              ctx.lineTo(particles[j].x, particles[j].y);
              ctx.strokeStyle = 'rgba(99,102,241,' + alpha + ')';
              ctx.stroke();
            }
          }
        }
      }

      function drawMatrix(){
        ctx.font = FONT_SIZE + 'px monospace';
        for(var i=0;i<columns;i++){
          if(drops[i]<0){ drops[i]++; continue; }
          var ch = MATRIX_CHARS[Math.random()*MATRIX_CHARS.length|0];
          var y = drops[i] * FONT_SIZE;
          // Bright head
          ctx.fillStyle = 'rgba(16,185,129,0.7)';
          ctx.fillText(ch, i*FONT_SIZE, y);
          // Trail
          if(y > FONT_SIZE){
            ctx.fillStyle = 'rgba(16,185,129,0.08)';
            ctx.fillText(MATRIX_CHARS[Math.random()*MATRIX_CHARS.length|0], i*FONT_SIZE, y - FONT_SIZE);
          }
          drops[i]++;
          if(y > h && Math.random() > 0.975){
            drops[i] = 0;
          }
        }
      }

      function tick(){
        if(!running) return;
        // Fade trail
        ctx.fillStyle = 'rgba(5,10,20,0.12)';
        ctx.fillRect(0, 0, w, h);
        drawMatrix();
        drawParticles();
        raf = requestAnimationFrame(tick);
      }

      window.__tmCanvasStart = function(){
        if(running) return;
        running = true;
        initCanvas();
        if(ctx){ ctx.fillStyle='#050a14'; ctx.fillRect(0,0,w,h); }
        tick();
      };
      window.__tmCanvasStop = function(){
        running = false;
        if(raf) cancelAnimationFrame(raf);
        raf = null;
      };
    })();

    /* â”€â”€ Brand Text Scramble/Decrypt Animation â”€â”€ */
    (function(){
      var BRAND = 'SENTRY MESSENGER';
      var GLYPHS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%&!?<>{}[]';
      var el, chars, resolved, frame, raf, running;

      function init(){
        el = document.getElementById('tmBrand');
        if(!el) return;
        el.innerHTML = '';
        chars = [];
        resolved = [];
        for(var i=0;i<BRAND.length;i++){
          var span = document.createElement('span');
          span.className = 'char scrambling';
          span.textContent = BRAND[i] === ' ' ? '\u00A0' : GLYPHS[Math.random()*GLYPHS.length|0];
          el.appendChild(span);
          chars.push(span);
          resolved.push(BRAND[i] === ' ');
        }
        frame = 0;
      }

      function tick(){
        if(!running) return;
        frame++;
        var revealIdx = Math.floor(frame / 6); // reveal 1 char every 6 frames (~100ms each)
        for(var i=0;i<chars.length;i++){
          if(BRAND[i] === ' ') continue;
          if(i <= revealIdx){
            if(!resolved[i]){
              chars[i].textContent = BRAND[i];
              chars[i].className = 'char resolved';
              resolved[i] = true;
            }
          } else {
            chars[i].textContent = GLYPHS[Math.random()*GLYPHS.length|0];
          }
        }
        if(revealIdx >= BRAND.length){
          // All resolved â€” keep stable
          running = false;
          return;
        }
        raf = requestAnimationFrame(tick);
      }

      window.__tmScrambleStart = function(){
        running = true;
        init();
        tick();
      };
      window.__tmScrambleStop = function(){
        running = false;
        if(raf) cancelAnimationFrame(raf);
        // Show final text
        if(el) el.textContent = BRAND;
      };
    })();
    </script>

    <script>
      const params = new URLSearchParams(location.search);
      window.API_ORIGIN = params.get('api') || 'https://api.message.sentry.red';
      (function(){
        const overlay = document.getElementById('orientationOverlay');
        const docEl = document.documentElement;
        const mq = window.matchMedia('(orientation: portrait)');
        const isMobileLike = () => {
          const touch = navigator.maxTouchPoints || navigator.msMaxTouchPoints || 0;
          const shortEdge = Math.min(window.innerWidth, window.innerHeight);
          const ua = navigator.userAgent || '';
          const looksMobileUA = /iPhone|iPad|Android|Mobile/i.test(ua);
          return shortEdge <= 1024 && (touch > 0 || looksMobileUA);
        };
        function update(){
          if (!isMobileLike()) {
            docEl.classList.remove('orientation-block');
            if (overlay) overlay.setAttribute('aria-hidden','true');
            return;
          }
          const portrait = mq.matches || window.innerHeight >= window.innerWidth;
          if (portrait) {
            docEl.classList.remove('orientation-block');
            if (overlay) overlay.setAttribute('aria-hidden','true');
          } else {
            docEl.classList.add('orientation-block');
            if (overlay) overlay.setAttribute('aria-hidden','false');
          }
        }
        if (mq.addEventListener) mq.addEventListener('change', update); else mq.addListener(update);
        window.addEventListener('orientationchange', update);
        window.addEventListener('resize', update);
        update();
        if (screen.orientation && screen.orientation.lock && isMobileLike()) {
          screen.orientation.lock('portrait').catch(() => {});
        }
      })();
      (function disablePinchZoom(){
        const prevent = (evt) => evt.preventDefault();
        document.addEventListener('gesturestart', prevent, { passive:false });
        document.addEventListener('gesturechange', prevent, { passive:false });
        document.addEventListener('gestureend', prevent, { passive:false });
      })();
    </script>
    <script>
      (function loadLoginModule(){
        const stamp = window.APP_BUILD_AT || window.APP_VERSION || String(Date.now());
        const script = document.createElement('script');
        script.type = 'module';
        script.src = `/app/ui/login-ui.js?v=${encodeURIComponent(stamp)}`;
        script.onerror = () => {
          if (script.dataset.retry) return;
          script.dataset.retry = '1';
          const fallback = document.createElement('script');
          fallback.type = 'module';
          fallback.src = `/app/ui/login-ui.js?v=${Date.now()}`;
          document.body.appendChild(fallback);
        };
        document.body.appendChild(script);
      })();
    </script>
  </body>
</html>
